<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M&M - Lista de Precios</title>
  <link rel="stylesheet" href="assets/styles.css?v=20251010" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <script src="./assets/js/config.js"></script>
  <script src="./assets/js/api.js"></script>
</head>
<body data-page="precios">
  <div class="topbar hidden" id="appHeader">
    <div class="topbar-inner">
      <div class="topbar-card">
        <div class="row between" style="align-items:center;gap:8px;flex-wrap:wrap;">
          <div class="brand">
            <img id="brandLogo" src="assets/lightlogo.png" alt="M&M logo" />
            <div class="company">Empresa: <span id="companyName">-</span></div>
          </div>
          <div class="row" style="gap:6px;align-items:center;">
            <button id="logoutBtn" class="secondary hidden">Salir</button>
            <button id="denseToggle" class="secondary" title="Modo compacto">📏</button>
            <button id="themeToggle" class="secondary" title="Cambiar tema">🌗</button>
          </div>
        </div>
        <div class="top-tabs">
          <nav class="tabs">
            <button data-tab="home" data-href="index.html">Inicio</button>
            <button data-tab="notas" data-feature="notas" data-href="notas.html">Notas</button>
            <button data-tab="ventas" data-feature="ventas" data-href="ventas.html">Ventas</button>
            <button data-tab="cotizaciones" data-feature="cotizaciones" data-href="cotizaciones.html">Cotizaciones</button>
            <button data-tab="inventario" data-feature="inventario" data-href="inventario.html">Inventario</button>
            <button data-tab="precios" data-feature="precios" data-href="precios.html" class="active">Lista de precios</button>
            <button data-tab="cashflow" data-feature="cashflow" data-href="cashflow.html">Flujo de Caja</button>
            <button data-tab="nomina" data-feature="payroll" data-href="nomina.html">Nómina</button>
            <button data-tab="formatos" data-feature="templates" data-href="template-selector.html">Formatos</button>
            <button data-tab="skus" data-feature="skus" data-href="skus.html">SKUs</button>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <main>
    <section id="appSection" class="hidden">

      <!-- MODAL GLOBAL -->
      <div id="modal" class="modal hidden">
        <div class="modal-content image-modal">
          <button id="modalClose" class="close">&times;</button>
          <div id="modalBody">
            <div id="modal-img-wrap">
              <img id="modal-img" src="" alt="Vista previa" />
              <div class="zoom-controls">
                <button id="zoom-in">+</button>
                <button id="zoom-out">-</button>
                <button id="zoom-reset">Reset</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== PRECIOS Y VEHÍCULOS ========== -->
      <section id="tab-precios" class="tab active">
        <!-- Tabs internas: Lista de precios y Vehículos -->
        <div class="card">
          <div class="payroll-tabs row wrap" style="gap:6px;align-items:center;margin-bottom:16px;">
            <button class="secondary active" data-subtab="prices">💰 Lista de precios</button>
            <button class="secondary" data-subtab="vehicles">🚗 Vehículos</button>
          </div>
        </div>

        <!-- Tab: Lista de precios -->
        <div class="card" data-subsection="prices">
          <h3>Lista de precios</h3>
          <div class="row" id="filters-bar" style="gap:8px;flex-wrap:wrap;align-items:end;margin-bottom:16px;">
            <div style="flex:1;min-width:250px;position:relative;">
              <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:500;">Seleccionar vehículo</label>
              <input id="pf-vehicle-search" placeholder="Buscar vehículo (marca, línea, cilindraje)..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);" />
              <div id="pf-vehicle-dropdown" style="display:none;position:absolute;z-index:1000;background:var(--card);border:1px solid var(--border);border-radius:6px;max-height:200px;overflow-y:auto;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.15);width:100%;"></div>
              <input type="hidden" id="pf-vehicle-id" />
              <div id="pf-vehicle-selected" style="margin-top:4px;font-size:12px;color:var(--muted);"></div>
              <p class="muted" style="margin-top:4px;font-size:11px;">Selecciona un vehículo para ver y gestionar sus servicios y productos</p>
            </div>
            <button id="pf-clear" class="secondary" style="padding:8px 16px;">🗑️ Limpiar</button>
          </div>
          <div id="pe-actions-bar" style="display:none;margin-bottom:16px;gap:8px;" class="row">
            <button id="pe-new-service" style="padding:8px 16px;">➕ Nuevo servicio</button>
            <button id="pe-new-product" style="padding:8px 16px;">➕ Nuevo producto</button>
            <button id="pe-new-combo" style="padding:8px 16px;background:#9333ea;color:white;border:none;">🎁 Nuevo combo</button>
          </div>
          <div id="pe-filters" style="display:none;margin-bottom:16px;gap:8px;flex-wrap:wrap;" class="row">
            <div style="flex:1;min-width:200px;">
              <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:500;">Buscar por nombre</label>
              <input id="pe-filter-name" placeholder="Nombre del servicio/producto..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);" />
            </div>
            <div style="min-width:150px;">
              <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:500;">Tipo</label>
              <select id="pe-filter-type" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);">
                <option value="">Todos</option>
                <option value="service">Servicios</option>
                <option value="product">Productos</option>
                <option value="combo">Combos</option>
              </select>
            </div>
            <div style="display:flex;align-items:end;">
              <button id="pf-search" class="secondary" style="padding:8px 16px;height:fit-content;">🔍 Buscar</button>
            </div>
          </div>
          <div class="card" style="margin-top:12px;">
            <div class="table-wrap" style="overflow-x:auto;width:100%;">
              <table class="table" id="pe-table" style="width:100%;table-layout:auto;">
                <thead id="pe-head"></thead>
                <tbody id="pe-body"></tbody>
              </table>
            </div>
            <div id="pe-pagination"></div>
          </div>
        </div>

        <!-- Tab: Vehículos -->
        <div class="card hidden" data-subsection="vehicles">
          <h3>Base de datos de vehículos</h3>
          <p class="muted" style="margin:0 0 16px 0;font-size:13px;">Gestiona la base de datos global de vehículos. Esta base es compartida por todas las empresas.</p>
          
          <!-- Formulario crear/editar vehículo -->
          <div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px;">
            <div style="margin-bottom:12px;">
              <h4 style="margin:0 0 8px 0;font-size:14px;font-weight:600;">Crear/Editar vehículo</h4>
            </div>
            <div class="row wrap" style="gap:12px;align-items:end;">
              <div style="flex:1;min-width:160px;">
                <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:500;">Marca</label>
                <input id="v-make" placeholder="Ej: RENAULT" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);text-transform:uppercase;" />
              </div>
              <div style="flex:1;min-width:160px;">
                <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:500;">Línea</label>
                <input id="v-line" placeholder="Ej: DUSTER" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);text-transform:uppercase;" />
              </div>
              <div style="min-width:120px;">
                <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:500;">Cilindraje</label>
                <input id="v-displacement" placeholder="Ej: 1.6" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);text-transform:uppercase;" />
              </div>
              <div style="min-width:160px;">
                <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:500;">Modelo (año o rango)</label>
                <input id="v-modelyear" placeholder="Ej: 2020 o 2018-2022" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);" />
                <p class="muted" style="margin:4px 0 0 0;font-size:11px;">Año fijo (2020) o rango (2018-2022). Dejar vacío si no aplica.</p>
              </div>
              <div style="min-width:120px;">
                <label style="display:block;font-size:12px;color:transparent;margin-bottom:4px;">&nbsp;</label>
                <button id="v-save" class="secondary" style="width:100%;padding:8px 16px;font-weight:600;">
                  💾 Guardar
                </button>
              </div>
            </div>
            <div id="v-msg" style="margin-top:12px;font-size:13px;"></div>
          </div>

          <!-- Filtros y búsqueda -->
          <div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px;">
            <div class="row wrap" style="gap:12px;align-items:end;">
              <div style="flex:2;min-width:200px;">
                <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:500;">Buscar</label>
                <input id="v-search" placeholder="Buscar por marca, línea o cilindraje..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);" />
              </div>
              <div style="min-width:140px;">
                <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:500;">Marca</label>
                <select id="v-filter-make" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);">
                  <option value="">Todas</option>
                </select>
              </div>
              <div style="min-width:120px;">
                <label style="display:block;font-size:12px;color:transparent;margin-bottom:4px;">&nbsp;</label>
                <button id="v-filter-btn" class="secondary" style="width:100%;padding:8px 16px;font-weight:600;">
                  🔍 Buscar
                </button>
              </div>
              <div style="min-width:120px;">
                <label style="display:block;font-size:12px;color:transparent;margin-bottom:4px;">&nbsp;</label>
                <button id="v-clear-btn" class="secondary" style="width:100%;padding:8px 16px;font-weight:600;">
                  🗑️ Limpiar
                </button>
              </div>
            </div>
          </div>

          <!-- Lista de vehículos -->
          <div>
            <div style="margin-bottom:12px;">
              <h4 style="margin:0;font-size:14px;font-weight:600;">Vehículos registrados</h4>
              <p class="muted" style="margin:4px 0 0 0;font-size:12px;">Total: <span id="v-count">0</span></p>
            </div>
            <div id="v-list" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:12px;">
              <div class="muted" style="grid-column:1/-1;text-align:center;font-size:12px;padding:16px;border:1px dashed var(--border);border-radius:8px;">
                Cargando vehículos...
              </div>
            </div>
          </div>
        </div>
      </section>

    </section>
  </main>

  <!-- Templates -->
  <template id="tpl-price-edit-row">
    <tr>
      <td data-vehicle></td>
      <td data-name></td>
      <td data-item-info style="font-size:11px;color:var(--muted);"></td>
      <td class="t-right"><input data-price type="number" step="0.01" /></td>
      <td class="t-center">
        <button class="edit" style="margin-right:4px;">✏️ Editar</button>
        <button class="save" style="margin-right:4px;">💾 Guardar</button>
        <button class="danger delete">🗑️ Borrar</button>
      </td>
    </tr>
  </template>

  <script type="module" src="./assets/js/prices.js" charset="utf-8"></script>
  <script type="module" src="./assets/js/app.js" charset="utf-8"></script>
  <script src="./assets/js/input-fix.js"></script>
</body>
</html>
