<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Admin</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: ['class', '.theme-light'],
      theme: {
        extend: {
          colors: {
            'dark-bg': '#0f172a',
            'dark-card': '#111827',
            'dark-card-alt': '#0b1220',
            'dark-text': '#e5e7eb',
            'dark-muted': '#9ca3af',
            'dark-border': '#1f2937',
          }
        }
      }
    }
  </script>
  <style>
    /* Estilos para modo claro - Sobrescribir colores de Tailwind */
    body.theme-light [class*="from-slate-900"][class*="via-slate-800"][class*="to-slate-900"],
    body.theme-light [class*="bg-gradient-to-r"][class*="from-slate-900"] {
      background: linear-gradient(to right, #f8fafc, #f1f5f9, #f8fafc) !important;
    }
    body.theme-light [class*="bg-slate-800/50"],
    body.theme-light [class*="bg-slate-800"][class*="/50"] {
      background-color: rgba(241, 245, 249, 0.8) !important;
    }
    body.theme-light [class*="bg-slate-800"]:not([class*="/"]):not([class*="hover"]):not([class*="from"]):not([class*="via"]):not([class*="to"]) {
      background-color: #f1f5f9 !important;
    }
    body.theme-light .text-white:not(.bg-blue-600):not(.bg-blue-700):not(.bg-purple-600):not(.bg-purple-700) {
      color: #0f172a !important;
    }
    body.theme-light .text-slate-300 {
      color: #475569 !important;
    }
    body.theme-light .text-slate-400 {
      color: #64748b !important;
    }
    body.theme-light [class*="border-slate-700/50"],
    body.theme-light [class*="border-slate-700"][class*="/50"] {
      border-color: rgba(203, 213, 225, 0.5) !important;
    }
    body.theme-light [class*="bg-slate-900/50"] {
      background-color: rgba(255, 255, 255, 0.9) !important;
    }
    body.theme-light [class*="bg-slate-700/50"] {
      background-color: rgba(203, 213, 225, 0.5) !important;
    }
    /* Mejorar contrastes en inputs y botones en modo claro */
    body.theme-light input[type="email"],
    body.theme-light input[type="password"],
    body.theme-light input[type="text"] {
      background-color: #ffffff !important;
      color: #0f172a !important;
      border-color: #cbd5e1 !important;
    }
    body.theme-light input[type="email"]::placeholder,
    body.theme-light input[type="password"]::placeholder,
    body.theme-light input[type="text"]::placeholder {
      color: #64748b !important;
    }
    body.theme-light #s-request {
      background-color: #ffffff !important;
      color: #0f172a !important;
      border: 2px solid #cbd5e1 !important;
    }
    body.theme-light #s-request:hover {
      background-color: #f8fafc !important;
      border-color: #94a3b8 !important;
    }
    /* Desactivar scroll en p谩gina de login admin */
    body:has(#loginSection:not(.hidden)) {
      overflow: hidden !important;
    }
  </style>
  <link rel="stylesheet" href="assets/styles.css?v=20251010" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <script src="./assets/js/config.js"></script>
  <script src="./assets/js/api.js"></script>
</head>
<body data-page="admin">
  <div class="topbar hidden" id="appHeader">
    <div class="topbar-inner">
      <div class="topbar-card">
        <div class="row between" style="align-items:center;gap:8px;flex-wrap:wrap;">
          <div class="brand">
            <img id="brandLogo" src="assets/lightlogo.png" alt="M&M logo" />
            <div class="company">Admin: <span id="adminEmail">-</span></div>
          </div>
          <div class="row" style="gap:6px;align-items:center;">
            <button id="adminLogout" class="secondary hidden">Salir</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main>
    <section id="loginSection" class="h-screen flex items-center justify-center px-4 overflow-hidden bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 theme-light:from-slate-50 theme-light:via-slate-100 theme-light:to-slate-50 relative">
      <!-- Bot贸n de cambio de tema -->
      <button id="themeToggleAdmin" class="absolute top-4 right-4 p-3 text-slate-300 dark:text-slate-300 theme-light:text-slate-700 hover:text-white dark:hover:text-white theme-light:hover:text-slate-900 hover:bg-slate-700/50 dark:hover:bg-slate-700/50 theme-light:hover:bg-slate-200/50 rounded-lg transition-colors duration-200 z-20" title="Cambiar tema"></button>
      <div class="w-full max-w-xl space-y-4">
        <!-- Card de Login Admin -->
        <div class="bg-slate-800/50 dark:bg-slate-800/50 theme-light:bg-white/90 rounded-xl shadow-2xl border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300/50 p-5 relative overflow-hidden">
          <!-- Decoraci贸n de fondo -->
          <div class="absolute inset-0 opacity-5">
            <div class="absolute top-0 right-0 w-48 h-48 bg-purple-500 rounded-full blur-3xl"></div>
            <div class="absolute bottom-0 left-0 w-48 h-48 bg-pink-500 rounded-full blur-3xl"></div>
          </div>
          
          <div class="relative z-10">
            <!-- Header -->
            <div class="text-center mb-4">
              <div class="flex justify-center mb-2">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center shadow-lg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
        </div>
      </div>
              <h2 class="text-lg font-bold text-white dark:text-white theme-light:text-slate-900 mb-1">Ingreso Admin/Developer</h2>
              <p class="text-xs text-slate-400 dark:text-slate-400 theme-light:text-slate-600">Accede al panel de administraci贸n</p>
            </div>

            <!-- Formulario -->
            <form class="space-y-3" onsubmit="event.preventDefault(); document.getElementById('a-login')?.click();">
              <div>
                <label for="a-email" class="block text-xs font-medium text-slate-300 dark:text-slate-300 theme-light:text-slate-700 mb-1.5">Correo</label>
                <input id="a-email" type="email" placeholder="admin@correo.com" class="w-full px-3 py-2 text-sm bg-slate-900/50 dark:bg-slate-900/50 theme-light:bg-white theme-light:!bg-white border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300 theme-light:!border-slate-300 rounded-lg text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 placeholder-slate-500 dark:placeholder-slate-500 theme-light:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" />
          </div>
          <div>
                <label for="a-password" class="block text-xs font-medium text-slate-300 dark:text-slate-300 theme-light:text-slate-700 mb-1.5">Contrase帽a</label>
                <input id="a-password" type="password" placeholder="********" class="w-full px-3 py-2 text-sm bg-slate-900/50 dark:bg-slate-900/50 theme-light:bg-white theme-light:!bg-white border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300 theme-light:!border-slate-300 rounded-lg text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 placeholder-slate-500 dark:placeholder-slate-500 theme-light:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" />
              </div>
              <button id="a-login" type="button" class="w-full px-4 py-2 text-sm bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-600 dark:to-purple-700 theme-light:from-purple-500 theme-light:to-purple-600 hover:from-purple-700 hover:to-purple-800 dark:hover:from-purple-700 dark:hover:to-purple-800 theme-light:hover:from-purple-600 theme-light:hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-200">Entrar</button>
            </form>
          </div>
        </div>

        <!-- Card de Registro Admin -->
        <div class="bg-slate-800/50 dark:bg-slate-800/50 theme-light:bg-white/90 rounded-xl shadow-2xl border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300/50 p-5 relative overflow-hidden">
          <!-- Decoraci贸n de fondo -->
          <div class="absolute inset-0 opacity-5">
            <div class="absolute top-0 left-0 w-48 h-48 bg-blue-500 rounded-full blur-3xl"></div>
            <div class="absolute bottom-0 right-0 w-48 h-48 bg-purple-500 rounded-full blur-3xl"></div>
          </div>
          
          <div class="relative z-10">
            <h3 class="text-base font-bold text-white dark:text-white theme-light:text-slate-900 mb-3">Crear cuenta de Admin</h3>
            <p class="text-xs text-slate-400 dark:text-slate-400 theme-light:text-slate-600 mb-4">Solicita un c贸digo de aprobaci贸n para crear tu cuenta de administrador.</p>
            
            <!-- Solicitar c贸digo -->
            <div class="space-y-3 mb-4">
              <div>
                <label for="s-email" class="block text-xs font-medium text-slate-300 dark:text-slate-300 theme-light:text-slate-700 mb-1.5">Correo</label>
                <div class="flex gap-2">
                  <input id="s-email" type="email" placeholder="tu-correo@dominio.com" class="flex-1 px-3 py-2 text-sm bg-slate-900/50 dark:bg-slate-900/50 theme-light:bg-white theme-light:!bg-white border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300 theme-light:!border-slate-300 rounded-lg text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 placeholder-slate-500 dark:placeholder-slate-500 theme-light:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" />
                  <button id="s-request" type="button" class="px-4 py-2 text-sm bg-slate-700/50 dark:bg-slate-700/50 theme-light:bg-white theme-light:!bg-white theme-light:border-2 theme-light:!border-2 theme-light:border-slate-300 theme-light:!border-slate-300 hover:bg-slate-700 dark:hover:bg-slate-700 theme-light:hover:bg-slate-50 theme-light:!hover:bg-slate-50 text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 font-semibold rounded-lg transition-all duration-200 whitespace-nowrap">Solicitar</button>
                </div>
              </div>
            </div>

            <div class="h-px bg-slate-700/50 dark:bg-slate-700/50 theme-light:bg-slate-300/50 my-4"></div>

            <!-- Confirmar registro -->
            <div class="space-y-3">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label for="s-code" class="block text-xs font-medium text-slate-300 dark:text-slate-300 theme-light:text-slate-700 mb-1.5">C贸digo</label>
                  <input id="s-code" type="text" placeholder="000000" class="w-full px-3 py-2 text-sm bg-slate-900/50 dark:bg-slate-900/50 theme-light:bg-white theme-light:!bg-white border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300 theme-light:!border-slate-300 rounded-lg text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 placeholder-slate-500 dark:placeholder-slate-500 theme-light:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" />
          </div>
          <div>
                  <label for="s-pass" class="block text-xs font-medium text-slate-300 dark:text-slate-300 theme-light:text-slate-700 mb-1.5">Contrase帽a</label>
                  <input id="s-pass" type="password" placeholder="********" class="w-full px-3 py-2 text-sm bg-slate-900/50 dark:bg-slate-900/50 theme-light:bg-white theme-light:!bg-white border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300 theme-light:!border-slate-300 rounded-lg text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 placeholder-slate-500 dark:placeholder-slate-500 theme-light:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" />
                </div>
              </div>
              <button id="s-confirm" type="button" class="w-full px-4 py-2 text-sm bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-600 dark:to-purple-700 theme-light:from-purple-500 theme-light:to-purple-600 hover:from-purple-700 hover:to-purple-800 dark:hover:from-purple-700 dark:hover:to-purple-800 theme-light:hover:from-purple-600 theme-light:hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-200">Confirmar registro</button>
              <div id="s-msg" class="text-xs text-slate-400 dark:text-slate-400 theme-light:text-slate-600 mt-2 text-center"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="appSection" class="hidden">
      <div class="card" style="max-width:1000px;margin:20px auto;">
        <div class="row between" style="align-items:center;gap:8px;flex-wrap:wrap;">
          <h3 style="margin:0;">Empresas</h3>
          <div class="row" style="gap:6px;">
            <button id="loadCompanies" class="secondary">Actualizar</button>
          </div>
        </div>
        <div class="table-wrap" style="margin-top:8px;">
          <table class="table">
            <thead><tr><th>Nombre</th><th>Email</th><th>Activa</th><th>Features</th><th></th></tr></thead>
            <tbody id="adm-body"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
  import { API } from './assets/js/api.esm.js';
  const LS_KEY = 'adm:token';
  function setToken(t){ try{ localStorage.setItem(LS_KEY, t||''); }catch{} }
  function getToken(){ try{ return localStorage.getItem(LS_KEY)||''; }catch{return '';} }
  async function req(path, opts={}){
    const tok = getToken();
    const headers = { 'Content-Type':'application/json', ...(tok?{Authorization:'Bearer '+tok}:{}) };
    const res = await fetch((API.base||'')+path, { ...opts, headers, body: opts.body?JSON.stringify(opts.body):undefined });
    const txt = await res.text(); let data; try{ data=JSON.parse(txt);}catch{ data=txt; }
    if(!res.ok) throw new Error(data?.error || res.statusText);
    return data;
  }
  const loginSec = document.getElementById('loginSection');
  const appSec = document.getElementById('appSection');
  const header = document.getElementById('appHeader');
  const emailLbl = document.getElementById('adminEmail');
  const logoutBtn = document.getElementById('adminLogout');
  let currentRole = null;

  async function enterDashboard(user, fallbackEmail){
    currentRole = user?.role || 'admin';
    emailLbl.textContent = user?.email || fallbackEmail || '-';
    loginSec.classList.add('hidden');
    appSec.classList.remove('hidden');
    header.classList.remove('hidden');
    logoutBtn.classList.remove('hidden');
    loadCompanies();
  }

  document.getElementById('a-login').onclick = async ()=>{
    const email = document.getElementById('a-email').value.trim().toLowerCase();
    const password = document.getElementById('a-password').value;
    try{
      const r = await req('/api/v1/admin/auth/login', { method:'POST', body:{ email, password } });
      setToken(r.token);
      await enterDashboard(r.user, email);
    }catch(e){ alert(e.message||'Error'); }
  };

  // Signup flow: request and confirm
  document.getElementById('s-request').onclick = async ()=>{
    const email = document.getElementById('s-email').value.trim().toLowerCase();
    const msg = document.getElementById('s-msg');
    msg.textContent = '';
    try{
      await req('/api/v1/admin/signup/request', { method:'POST', body:{ email } });
      msg.textContent = 'Solicitud enviada. Contacta al developer para recibir tu codigo.';
    }catch(e){ msg.textContent = e.message||'Error'; }
  };
  document.getElementById('s-confirm').onclick = async ()=>{
    const email = document.getElementById('s-email').value.trim().toLowerCase();
    const code = document.getElementById('s-code').value.trim();
    const password = document.getElementById('s-pass').value;
    const msg = document.getElementById('s-msg');
    msg.textContent='';
    try{
      const r = await req('/api/v1/admin/signup/confirm', { method:'POST', body:{ email, code, password } });
      setToken(r.token);
      await enterDashboard(r.user, email);
    }catch(e){ msg.textContent = e.message||'Error'; }
  };

  logoutBtn.addEventListener('click', ()=>{
    setToken('');
    currentRole = null;
    emailLbl.textContent = '-';
    appSec.classList.add('hidden');
    header.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    document.getElementById('adm-body').innerHTML = '';
    loginSec.classList.remove('hidden');
  });

  async function loadCompanies(){
    const tbody = document.getElementById('adm-body');
    tbody.innerHTML = '<tr><td colspan="5" class="t-center">Cargando...</td></tr>';
    try{
      const r = await req('/api/v1/admin/companies');
      const companies = r.items || [];
      const role = currentRole || r.role || 'admin';
      tbody.innerHTML='';
      if(!companies.length){
        tbody.innerHTML = '<tr><td colspan="5" class="t-center muted">Sin empresas asignadas</td></tr>';
        return;
      }
      companies.forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.name || '-'}</td><td>${c.email || '-'}</td><td>${c.active ? 'Si' : 'No'}</td><td class="adm-features"></td><td class="adm-actions"></td>`;
        const featuresTd = tr.querySelector('.adm-features');
        const actionsTd = tr.querySelector('.adm-actions');
        if(role === 'developer'){
          const list = document.createElement('div');
          list.className = 'row wrap';
          list.style.gap = '6px';
          const feats = c.features || {};
          Object.keys(feats).forEach(k=>{
            const label = document.createElement('label');
            label.className = 'chip';
            label.innerHTML = `<input type="checkbox" data-feature="${k}" ${feats[k] !== false ? 'checked' : ''}/> ${k}`;
            list.appendChild(label);
          });
          featuresTd.appendChild(list);
        }else{
          featuresTd.innerHTML = '<span>Funciones disponibles</span>';
        }

        const actions = document.createElement('div');
        actions.className = 'row wrap';
        actions.style.gap = '6px';

        if(role === 'developer'){
          const saveFeatures = document.createElement('button');
          saveFeatures.className = 'secondary';
          saveFeatures.textContent = 'Guardar features';
          saveFeatures.onclick = async ()=>{
            const patch = {};
            featuresTd.querySelectorAll('input[data-feature]').forEach(ch => {
              patch[ch.dataset.feature] = ch.checked;
            });
            try{
              await req(`/api/v1/admin/company/companies/${c._id}/features`, { method:'PATCH', body: patch });
              alert('Features guardados');
            }catch(e){ alert(e.message||'Error'); }
          };
          actions.appendChild(saveFeatures);

          // Restricciones removidas - no hay bot贸n de guardar restricciones
        }

        actionsTd.appendChild(actions);
        tbody.appendChild(tr);
      });
    }catch(e){
      tbody.innerHTML = `<tr><td colspan='5' class='t-center'>${e.message||'Error'}</td></tr>`;
    }
  }
  document.getElementById('loadCompanies').onclick = loadCompanies;

  (async ()=>{
    if(!getToken()) return;
    try{
      const me = await req('/api/v1/admin/auth/me');
      await enterDashboard(me.user, me?.user?.email);
    }catch{
      setToken('');
    }
  })();

  // Event listener para bot贸n de cambio de tema en admin
  document.addEventListener('DOMContentLoaded', () => {
    const themeBtn = document.getElementById('themeToggleAdmin');
    if (themeBtn) {
      themeBtn.addEventListener('click', () => {
        const isLight = document.body.classList.contains('theme-light');
        const newTheme = isLight ? 'dark' : 'light';
        
        // Intentar usar applyTheme si est谩 disponible
        if (typeof window.applyTheme === 'function') {
          window.applyTheme(newTheme);
        } else {
          // Fallback manual
          document.body.classList.toggle('theme-light');
          try {
            localStorage.setItem('app:theme', newTheme);
          } catch {}
          // Actualizar icono del bot贸n
          themeBtn.textContent = newTheme === 'light' ? '' : '';
          themeBtn.title = newTheme === 'light' ? 'Cambiar a oscuro' : 'Cambiar a claro';
        }
      });
      
      // Inicializar icono del bot贸n seg煤n el tema actual
      const currentTheme = document.body.classList.contains('theme-light') ? 'light' : 'dark';
      themeBtn.textContent = currentTheme === 'light' ? '' : '';
      themeBtn.title = currentTheme === 'light' ? 'Cambiar a oscuro' : 'Cambiar a claro';
    }
    
    // Aplicar tema inicial si est谩 guardado
    try {
      const stored = localStorage.getItem('app:theme');
      if (stored === 'light' || stored === 'dark') {
        if (typeof window.applyTheme === 'function') {
          window.applyTheme(stored);
        } else {
          if (stored === 'light') {
            document.body.classList.add('theme-light');
          } else {
            document.body.classList.remove('theme-light');
          }
          if (themeBtn) {
            themeBtn.textContent = stored === 'light' ? '' : '';
            themeBtn.title = stored === 'light' ? 'Cambiar a oscuro' : 'Cambiar a claro';
          }
        }
      }
    } catch {}
  });
  </script>
</body>
</html>

