<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Admin</title>
  <link rel="stylesheet" href="assets/styles.css?v=20251010" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <script src="./assets/js/config.js"></script>
  <script src="./assets/js/api.js"></script>
</head>
<body data-page="admin">
  <div class="topbar hidden" id="appHeader">
    <div class="topbar-inner">
      <div class="topbar-card">
        <div class="row between" style="align-items:center;gap:8px;flex-wrap:wrap;">
          <div class="brand">
            <img id="brandLogo" src="assets/lightlogo.png" alt="M&M logo" />
            <div class="company">Admin: <span id="adminEmail">-</span></div>
          </div>
          <div class="row" style="gap:6px;align-items:center;">
            <button id="adminLogout" class="secondary hidden">Salir</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main>
    <section id="loginSection">
      <div class="card" style="max-width:460px;margin:40px auto;">
        <h2>Ingreso Admin/Developer</h2>
        <label>Correo</label>
        <input id="a-email" type="email" />
        <label>Contraseña</label>
        <input id="a-password" type="password" />
        <div class="row" style="gap:8px;margin-top:8px;">
          <button id="a-login">Entrar</button>
        </div>
      </div>
      <div class="card" style="max-width:460px;margin:20px auto;">
        <h3 style="margin-top:0">Crear cuenta de Admin (con código de aprobación)</h3>
        <div class="row wrap" style="gap:10px;align-items:flex-end;">
          <div style="flex:1;min-width:220px;">
            <label>Correo</label>
            <input id="s-email" type="email" placeholder="tu-correo@dominio.com" />
          </div>
          <div>
            <button id="s-request" class="secondary">Solicitar código</button>
          </div>
        </div>
        <div class="sep" style="height:1px;background:var(--border);margin:12px 0;"></div>
        <div class="row wrap" style="gap:10px;align-items:flex-end;">
          <div style="flex:1;min-width:200px;">
            <label>Código</label>
            <input id="s-code" type="text" placeholder="000000" />
          </div>
          <div style="flex:1;min-width:220px;">
            <label>Contraseña</label>
            <input id="s-pass" type="password" placeholder="********" />
          </div>
          <div>
            <button id="s-confirm">Confirmar registro</button>
          </div>
        </div>
        <div id="s-msg" class="muted" style="margin-top:8px;font-size:12px;"></div>
      </div>
    </section>

    <section id="appSection" class="hidden">
      <div class="card" style="max-width:1000px;margin:20px auto;">
        <div class="row between" style="align-items:center;gap:8px;flex-wrap:wrap;">
          <h3 style="margin:0;">Empresas</h3>
          <div class="row" style="gap:6px;">
            <button id="loadCompanies" class="secondary">Actualizar</button>
          </div>
        </div>
        <div class="table-wrap" style="margin-top:8px;">
          <table class="table">
            <thead><tr><th>Nombre</th><th>Email</th><th>Activa</th><th>Features</th><th></th></tr></thead>
            <tbody id="adm-body"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
  import { API } from './assets/js/api.esm.js';
  const LS_KEY = 'adm:token';
  function setToken(t){ try{ localStorage.setItem(LS_KEY, t||''); }catch{} }
  function getToken(){ try{ return localStorage.getItem(LS_KEY)||''; }catch{return '';} }
  async function req(path, opts={}){
    const tok = getToken();
    const headers = { 'Content-Type':'application/json', ...(tok?{Authorization:'Bearer '+tok}:{}) };
    const res = await fetch((API.base||'')+path, { ...opts, headers, body: opts.body?JSON.stringify(opts.body):undefined });
    const txt = await res.text(); let data; try{ data=JSON.parse(txt);}catch{ data=txt; }
    if(!res.ok) throw new Error(data?.error || res.statusText);
    return data;
  }
  const loginSec = document.getElementById('loginSection');
  const appSec = document.getElementById('appSection');
  const header = document.getElementById('appHeader');
  const emailLbl = document.getElementById('adminEmail');
  const logoutBtn = document.getElementById('adminLogout');
  let currentRole = null;

  async function enterDashboard(user, fallbackEmail){
    currentRole = user?.role || 'admin';
    emailLbl.textContent = user?.email || fallbackEmail || '-';
    loginSec.classList.add('hidden');
    appSec.classList.remove('hidden');
    header.classList.remove('hidden');
    logoutBtn.classList.remove('hidden');
    loadCompanies();
  }

  document.getElementById('a-login').onclick = async ()=>{
    const email = document.getElementById('a-email').value.trim().toLowerCase();
    const password = document.getElementById('a-password').value;
    try{
      const r = await req('/api/v1/admin/auth/login', { method:'POST', body:{ email, password } });
      setToken(r.token);
      await enterDashboard(r.user, email);
    }catch(e){ alert(e.message||'Error'); }
  };

  // Signup flow: request and confirm
  document.getElementById('s-request').onclick = async ()=>{
    const email = document.getElementById('s-email').value.trim().toLowerCase();
    const msg = document.getElementById('s-msg');
    msg.textContent = '';
    try{
      await req('/api/v1/admin/signup/request', { method:'POST', body:{ email } });
      msg.textContent = 'Solicitud enviada. Contacta al developer para recibir tu codigo.';
    }catch(e){ msg.textContent = e.message||'Error'; }
  };
  document.getElementById('s-confirm').onclick = async ()=>{
    const email = document.getElementById('s-email').value.trim().toLowerCase();
    const code = document.getElementById('s-code').value.trim();
    const password = document.getElementById('s-pass').value;
    const msg = document.getElementById('s-msg');
    msg.textContent='';
    try{
      const r = await req('/api/v1/admin/signup/confirm', { method:'POST', body:{ email, code, password } });
      setToken(r.token);
      await enterDashboard(r.user, email);
    }catch(e){ msg.textContent = e.message||'Error'; }
  };

  logoutBtn.addEventListener('click', ()=>{
    setToken('');
    currentRole = null;
    emailLbl.textContent = '-';
    appSec.classList.add('hidden');
    header.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    document.getElementById('adm-body').innerHTML = '';
    loginSec.classList.remove('hidden');
  });

  async function loadCompanies(){
    const tbody = document.getElementById('adm-body');
    tbody.innerHTML = '<tr><td colspan="5" class="t-center">Cargando...</td></tr>';
    try{
      const r = await req('/api/v1/admin/companies');
      const companies = r.items || [];
      const role = currentRole || r.role || 'admin';
      tbody.innerHTML='';
      if(!companies.length){
        tbody.innerHTML = '<tr><td colspan="5" class="t-center muted">Sin empresas asignadas</td></tr>';
        return;
      }
      companies.forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.name || '-'}</td><td>${c.email || '-'}</td><td>${c.active ? 'Si' : 'No'}</td><td class="adm-features"></td><td class="adm-actions"></td>`;
        const featuresTd = tr.querySelector('.adm-features');
        const actionsTd = tr.querySelector('.adm-actions');
        const hideBalances = !!(c?.restrictions?.cashflow?.hideBalances);

        if(role === 'developer'){
          const list = document.createElement('div');
          list.className = 'row wrap';
          list.style.gap = '6px';
          const feats = c.features || {};
          Object.keys(feats).forEach(k=>{
            const label = document.createElement('label');
            label.className = 'chip';
            label.innerHTML = `<input type="checkbox" data-feature="${k}" ${feats[k] !== false ? 'checked' : ''}/> ${k}`;
            list.appendChild(label);
          });
          featuresTd.appendChild(list);
        }else{
          featuresTd.innerHTML = hideBalances
            ? '<span class="muted">Balances ocultos</span>'
            : '<span>Balances visibles</span>';
        }

        const actions = document.createElement('div');
        actions.className = 'row wrap';
        actions.style.gap = '6px';
        const hideLabel = document.createElement('label');
        hideLabel.className = 'chip';
        hideLabel.innerHTML = `<input type="checkbox" data-hide="${c._id}" ${hideBalances ? 'checked' : ''}/> Ocultar balances`;
        actions.appendChild(hideLabel);

        if(role === 'developer'){
          const saveFeatures = document.createElement('button');
          saveFeatures.className = 'secondary';
          saveFeatures.textContent = 'Guardar features';
          saveFeatures.onclick = async ()=>{
            const patch = {};
            featuresTd.querySelectorAll('input[data-feature]').forEach(ch => {
              patch[ch.dataset.feature] = ch.checked;
            });
            try{
              await req(`/api/v1/admin/company/companies/${c._id}/features`, { method:'PATCH', body: patch });
              alert('Features guardados');
            }catch(e){ alert(e.message||'Error'); }
          };
          actions.appendChild(saveFeatures);

          const saveRestrictions = document.createElement('button');
          saveRestrictions.className = 'secondary';
          saveRestrictions.textContent = 'Guardar restricciones';
          saveRestrictions.onclick = async ()=>{
            const hide = !!tr.querySelector(`input[data-hide="${c._id}"]`)?.checked;
            try{
              await req(`/api/v1/admin/company/companies/${c._id}/restrictions`, { method:'PATCH', body:{ cashflow:{ hideBalances: hide } } });
              alert('Restricciones guardadas');
            }catch(e){ alert(e.message||'Error'); }
          };
          actions.appendChild(saveRestrictions);
        }else{
          const saveHide = document.createElement('button');
          saveHide.className = 'secondary';
          saveHide.textContent = 'Guardar';
          saveHide.onclick = async ()=>{
            const hide = !!tr.querySelector(`input[data-hide="${c._id}"]`)?.checked;
            try{
              await req(`/api/v1/admin/company/companies/${c._id}/restrictions`, { method:'PATCH', body:{ cashflow:{ hideBalances: hide } } });
              alert('Restriccion actualizada');
            }catch(e){ alert(e.message||'Error'); }
          };
          actions.appendChild(saveHide);
        }

        actionsTd.appendChild(actions);
        tbody.appendChild(tr);
      });
    }catch(e){
      tbody.innerHTML = `<tr><td colspan='5' class='t-center'>${e.message||'Error'}</td></tr>`;
    }
  }
  document.getElementById('loadCompanies').onclick = loadCompanies;

  (async ()=>{
    if(!getToken()) return;
    try{
      const me = await req('/api/v1/admin/auth/me');
      await enterDashboard(me.user, me?.user?.email);
    }catch{
      setToken('');
    }
  })();
  </script>
</body>
</html>


