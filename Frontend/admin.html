<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Admin</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: ['class', '.theme-light'],
      theme: {
        extend: {
          colors: {
            'dark-bg': '#000000',
            'dark-card': '#111827',
            'dark-card-alt': '#0b1220',
            'dark-text': '#e5e7eb',
            'dark-muted': '#9ca3af',
            'dark-border': '#1f2937',
          }
        }
      }
    }
  </script>
  <style>
    /* Estilos para modo claro - Sobrescribir colores de Tailwind */
    body.theme-light [class*="from-slate-900"][class*="via-slate-800"][class*="to-slate-900"],
    body.theme-light [class*="bg-gradient-to-r"][class*="from-slate-900"] {
      background: linear-gradient(to right, #e0f2fe, #e0f2fe, #e0f2fe) !important;
    }
    body.theme-light [class*="bg-slate-800/50"],
    body.theme-light [class*="bg-slate-800"][class*="/50"] {
      background-color: rgba(224, 242, 254, 0.9) !important;
    }
    body.theme-light [class*="bg-slate-800"]:not([class*="/"]):not([class*="hover"]):not([class*="from"]):not([class*="via"]):not([class*="to"]) {
      background-color: #e0f2fe !important;
    }
    body.theme-light .text-white:not(.bg-blue-600):not(.bg-blue-700):not(.bg-purple-600):not(.bg-purple-700) {
      color: #000000 !important;
    }
    body.theme-light .text-slate-300 {
      color: #000000 !important;
    }
    body.theme-light .text-slate-400 {
      color: #000000 !important;
    }
    body.theme-light .text-slate-500 {
      color: #000000 !important;
    }
    body.theme-light .text-slate-600 {
      color: #000000 !important;
    }
    body.theme-light .text-slate-700 {
      color: #000000 !important;
    }
    body.theme-light .text-slate-800 {
      color: #000000 !important;
    }
    /* Mejorar contraste en modales - Forzar texto negro */
    body.theme-light #modal,
    body.theme-light #modal *:not(.bg-blue-600):not(.bg-blue-700):not(.bg-green-600):not(.bg-green-700):not(.bg-red-600):not(.bg-red-700):not(.bg-yellow-600):not(.bg-yellow-700):not(.bg-purple-600):not(.bg-purple-700) {
      color: #000000 !important;
    }
    body.theme-light #modal label,
    body.theme-light #modal .text-slate-300,
    body.theme-light #modal .text-slate-400,
    body.theme-light #modal .text-slate-500,
    body.theme-light #modal .text-slate-600,
    body.theme-light #modal .text-slate-700,
    body.theme-light #modal .text-slate-800,
    body.theme-light #modal h1,
    body.theme-light #modal h2,
    body.theme-light #modal h3,
    body.theme-light #modal h4,
    body.theme-light #modal p,
    body.theme-light #modal span,
    body.theme-light #modal div:not(.bg-blue-600):not(.bg-blue-700):not(.bg-green-600):not(.bg-green-700):not(.bg-red-600):not(.bg-red-700) {
      color: #000000 !important;
    }
    /* Mejorar contraste en selects y dropdowns */
    body.theme-light select,
    body.theme-light select option,
    body.theme-light select.text-slate-300,
    body.theme-light select.text-slate-400,
    body.theme-light select.text-slate-500,
    body.theme-light select.text-slate-600,
    body.theme-light select.text-slate-700,
    body.theme-light select.text-slate-800 {
      color: #000000 !important;
      background-color: #ffffff !important;
    }
    body.theme-light select option {
      color: #000000 !important;
      background-color: #ffffff !important;
    }
    /* Mejorar contraste en inputs dentro de modales */
    body.theme-light #modal input,
    body.theme-light #modal textarea,
    body.theme-light #modal select {
      color: #000000 !important;
    }
    body.theme-light #modal input::placeholder,
    body.theme-light #modal textarea::placeholder {
      color: #666666 !important;
    }
    /* Mejorar contraste en dropdowns de vehículos y otros */
    body.theme-light [id*="dropdown"],
    body.theme-light [id*="Dropdown"],
    body.theme-light [class*="dropdown"],
    body.theme-light [class*="Dropdown"] {
      background-color: #ffffff !important;
      color: #000000 !important;
    }
    body.theme-light [id*="dropdown"] *,
    body.theme-light [id*="Dropdown"] *,
    body.theme-light [class*="dropdown"] *,
    body.theme-light [class*="Dropdown"] * {
      color: #000000 !important;
    }
    /* Cambiar fondos grises de formularios a blanco/celeste claro */
    body.theme-light input[class*="bg-slate-900"],
    body.theme-light textarea[class*="bg-slate-900"],
    body.theme-light select[class*="bg-slate-900"],
    body.theme-light input[class*="bg-slate-800"],
    body.theme-light textarea[class*="bg-slate-800"],
    body.theme-light select[class*="bg-slate-800"] {
      background-color: #ffffff !important;
    }
    body.theme-light input[class*="bg-slate-900/50"],
    body.theme-light textarea[class*="bg-slate-900/50"],
    body.theme-light select[class*="bg-slate-900/50"],
    body.theme-light input[class*="bg-slate-800/50"],
    body.theme-light textarea[class*="bg-slate-800/50"],
    body.theme-light select[class*="bg-slate-800/50"] {
      background-color: #ffffff !important;
    }
    /* Cambiar fondo del modal a blanco */
    body.theme-light #modal > div,
    body.theme-light #modal .bg-slate-800:not([class*="hover"]),
    body.theme-light #modal [class*="bg-slate-800"]:not([class*="hover"]):not([class*="text"]) {
      background-color: #ffffff !important;
    }
    body.theme-light #modal .bg-slate-800/50,
    body.theme-light #modal [class*="bg-slate-800/50"] {
      background-color: rgba(255, 255, 255, 0.95) !important;
    }
    /* Cambiar todos los inputs, textareas y selects dentro de modales */
    body.theme-light #modal input:not([type="checkbox"]):not([type="radio"]),
    body.theme-light #modal textarea,
    body.theme-light #modal select {
      background-color: #ffffff !important;
      border-color: #7dd3fc !important;
    }
    /* Cambiar fondos de formularios en toda la página */
    body.theme-light input:not([type="checkbox"]):not([type="radio"]):not([class*="bg-blue"]):not([class*="bg-green"]):not([class*="bg-red"]):not([class*="bg-yellow"]):not([class*="bg-purple"]),
    body.theme-light textarea:not([class*="bg-blue"]):not([class*="bg-green"]):not([class*="bg-red"]):not([class*="bg-yellow"]):not([class*="bg-purple"]),
    body.theme-light select:not([class*="bg-blue"]):not([class*="bg-green"]):not([class*="bg-red"]):not([class*="bg-yellow"]):not([class*="bg-purple"]) {
      background-color: #ffffff !important;
    }
    body.theme-light [class*="border-slate-700/50"],
    body.theme-light [class*="border-slate-700"][class*="/50"] {
      border-color: rgba(125, 211, 252, 0.5) !important;
    }
    body.theme-light [class*="bg-slate-900/50"] {
      background-color: rgba(255, 255, 255, 0.9) !important;
    }
    body.theme-light [class*="bg-slate-700/50"] {
      background-color: rgba(125, 211, 252, 0.5) !important;
    }
    /* Mejorar contrastes en inputs y botones en modo claro */
    body.theme-light input[type="email"],
    body.theme-light input[type="password"],
    body.theme-light input[type="text"] {
      background-color: #ffffff !important;
      color: #000000 !important;
      border-color: #7dd3fc !important;
    }
    body.theme-light input[type="email"]::placeholder,
    body.theme-light input[type="password"]::placeholder,
    body.theme-light input[type="text"]::placeholder {
      color: #000000 !important;
    }
    body.theme-light #s-request {
      background-color: #ffffff !important;
      color: #000000 !important;
      border: 2px solid #7dd3fc !important;
    }
    body.theme-light #s-request:hover {
      background-color: #e0f2fe !important;
      border-color: #7dd3fc !important;
    }
    /* Desactivar scroll en página de login admin */
    body:has(#loginSection:not(.hidden)) {
      overflow: hidden !important;
    }
    /* Asegurar ancho completo en admin */
    body[data-page="admin"] {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }
    body[data-page="admin"] main {
      width: 100%;
      max-width: 100%;
    }
    body[data-page="admin"] #appSection {
      width: 100%;
      max-width: 100%;
    }
    /* Asegurar que la barra de navegación sea scrollable horizontalmente */
    body[data-page="admin"] nav {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    /* Estilos para la pestaña ADMIN destacada */
    body[data-page="admin"] .nav-tab[data-tab="admin"] {
      position: relative;
      z-index: 10;
    }
    body[data-page="admin"] .nav-tab[data-tab="admin"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
    }
  </style>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <script src="./assets/js/cache-buster.js"></script>
  <link rel="stylesheet" href="assets/styles.css?v=20251010" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <script src="./assets/js/config.js"></script>
  <script src="./assets/js/api.js"></script>
</head>
<body data-page="admin">
  <div class="topbar sticky top-0 z-[1000] hidden" id="appHeader">
    <div class="topbar-inner">
      <div class="topbar-card">
        <div class="row between" style="align-items:center;gap:8px;flex-wrap:wrap;">
          <div class="brand">
            <img id="brandLogo" src="assets/lightlogo.png" alt="M&M logo" />
            <div class="company">Admin: <span id="adminEmail">-</span></div>
          </div>
          <div class="row" style="gap:6px;align-items:center;">
            <button id="adminLogout" class="secondary hidden">Salir</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main>
    <section id="loginSection" class="h-screen flex items-center justify-center px-4 overflow-hidden bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 theme-light:from-slate-50 theme-light:via-slate-100 theme-light:to-slate-50 relative">
      <!-- Botón de cambio de tema -->
      <button id="themeToggleAdmin" class="absolute top-4 right-4 p-3 text-slate-300 dark:text-slate-300 theme-light:text-slate-700 hover:text-white dark:hover:text-white theme-light:hover:text-slate-900 hover:bg-slate-700/50 dark:hover:bg-slate-700/50 theme-light:hover:bg-slate-200/50 rounded-lg transition-colors duration-200 z-20" title="Cambiar tema">🌗</button>
      <div class="w-full max-w-xl space-y-4">
        <!-- Card de Login Admin -->
        <div class="bg-slate-800/50 dark:bg-slate-800/50 theme-light:bg-sky-50/90 rounded-xl shadow-2xl border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300/50 p-5 relative overflow-hidden">
          <!-- Decoración de fondo -->
          <div class="absolute inset-0 opacity-5">
            <div class="absolute top-0 right-0 w-48 h-48 bg-purple-500 rounded-full blur-3xl"></div>
            <div class="absolute bottom-0 left-0 w-48 h-48 bg-pink-500 rounded-full blur-3xl"></div>
          </div>
          
          <div class="relative z-10">
            <!-- Header -->
            <div class="text-center mb-4">
              <div class="flex justify-center mb-2">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center shadow-lg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
        </div>
      </div>
              <h2 class="text-lg font-bold text-white dark:text-white theme-light:text-slate-900 mb-1">Ingreso Admin/Developer</h2>
              <p class="text-xs text-slate-400 dark:text-slate-400 theme-light:text-slate-600">Accede al panel de administración</p>
            </div>

            <!-- Formulario -->
            <form class="space-y-3" onsubmit="event.preventDefault(); document.getElementById('a-login')?.click();">
              <div>
                <label for="a-email" class="block text-xs font-medium text-slate-300 dark:text-slate-300 theme-light:text-slate-700 mb-1.5">Correo</label>
                <input id="a-email" type="email" placeholder="admin@correo.com" class="w-full px-3 py-2 text-sm bg-slate-900/50 dark:bg-slate-900/50 theme-light:bg-sky-50 theme-light:!bg-white border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300 theme-light:!border-slate-300 rounded-lg text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 placeholder-slate-500 dark:placeholder-slate-500 theme-light:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" />
          </div>
          <div>
                <label for="a-password" class="block text-xs font-medium text-slate-300 dark:text-slate-300 theme-light:text-slate-700 mb-1.5">Contraseña</label>
                <input id="a-password" type="password" placeholder="********" class="w-full px-3 py-2 text-sm bg-slate-900/50 dark:bg-slate-900/50 theme-light:bg-sky-50 theme-light:!bg-white border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300 theme-light:!border-slate-300 rounded-lg text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 placeholder-slate-500 dark:placeholder-slate-500 theme-light:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" />
              </div>
              <button id="a-login" type="button" class="w-full px-4 py-2 text-sm bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-600 dark:to-purple-700 theme-light:from-purple-500 theme-light:to-purple-600 hover:from-purple-700 hover:to-purple-800 dark:hover:from-purple-700 dark:hover:to-purple-800 theme-light:hover:from-purple-600 theme-light:hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-200">Entrar</button>
            </form>
          </div>
        </div>

        <!-- Card de Registro Admin -->
        <div class="bg-slate-800/50 dark:bg-slate-800/50 theme-light:bg-sky-50/90 rounded-xl shadow-2xl border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300/50 p-5 relative overflow-hidden">
          <!-- Decoración de fondo -->
          <div class="absolute inset-0 opacity-5">
            <div class="absolute top-0 left-0 w-48 h-48 bg-blue-500 rounded-full blur-3xl"></div>
            <div class="absolute bottom-0 right-0 w-48 h-48 bg-purple-500 rounded-full blur-3xl"></div>
          </div>
          
          <div class="relative z-10">
            <h3 class="text-base font-bold text-white dark:text-white theme-light:text-slate-900 mb-3">Crear cuenta de Admin</h3>
            <p class="text-xs text-slate-400 dark:text-slate-400 theme-light:text-slate-600 mb-4">Solicita un código de aprobación para crear tu cuenta de administrador.</p>
            
            <!-- Solicitar código -->
            <div class="space-y-3 mb-4">
              <div>
                <label for="s-email" class="block text-xs font-medium text-slate-300 dark:text-slate-300 theme-light:text-slate-700 mb-1.5">Correo</label>
                <div class="flex gap-2">
                  <input id="s-email" type="email" placeholder="tu-correo@dominio.com" class="flex-1 px-3 py-2 text-sm bg-slate-900/50 dark:bg-slate-900/50 theme-light:bg-sky-50 theme-light:!bg-white border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300 theme-light:!border-slate-300 rounded-lg text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 placeholder-slate-500 dark:placeholder-slate-500 theme-light:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" />
                  <button id="s-request" type="button" class="px-4 py-2 text-sm bg-slate-700/50 dark:bg-slate-700/50 theme-light:bg-sky-50 theme-light:!bg-white theme-light:border-2 theme-light:!border-2 theme-light:border-slate-300 theme-light:!border-slate-300 hover:bg-slate-700 dark:hover:bg-slate-700 theme-light:hover:bg-slate-50 theme-light:!hover:bg-slate-50 text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 font-semibold rounded-lg transition-all duration-200 whitespace-nowrap">Solicitar</button>
                </div>
              </div>
            </div>

            <div class="h-px bg-slate-700/50 dark:bg-slate-700/50 theme-light:bg-sky-300/50 my-4"></div>

            <!-- Confirmar registro -->
            <div class="space-y-3">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label for="s-code" class="block text-xs font-medium text-slate-300 dark:text-slate-300 theme-light:text-slate-700 mb-1.5">Código</label>
                  <input id="s-code" type="text" placeholder="000000" class="w-full px-3 py-2 text-sm bg-slate-900/50 dark:bg-slate-900/50 theme-light:bg-sky-50 theme-light:!bg-white border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300 theme-light:!border-slate-300 rounded-lg text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 placeholder-slate-500 dark:placeholder-slate-500 theme-light:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" />
          </div>
          <div>
                  <label for="s-pass" class="block text-xs font-medium text-slate-300 dark:text-slate-300 theme-light:text-slate-700 mb-1.5">Contraseña</label>
                  <input id="s-pass" type="password" placeholder="********" class="w-full px-3 py-2 text-sm bg-slate-900/50 dark:bg-slate-900/50 theme-light:bg-sky-50 theme-light:!bg-white border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300 theme-light:!border-slate-300 rounded-lg text-white dark:text-white theme-light:text-slate-900 theme-light:!text-slate-900 placeholder-slate-500 dark:placeholder-slate-500 theme-light:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" />
                </div>
              </div>
              <button id="s-confirm" type="button" class="w-full px-4 py-2 text-sm bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-600 dark:to-purple-700 theme-light:from-purple-500 theme-light:to-purple-600 hover:from-purple-700 hover:to-purple-800 dark:hover:from-purple-700 dark:hover:to-purple-800 theme-light:hover:from-purple-600 theme-light:hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-200">Confirmar registro</button>
              <div id="s-msg" class="text-xs text-slate-400 dark:text-slate-400 theme-light:text-slate-600 mt-2 text-center"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Selector de Empresa -->
    <section id="companySelectorSection" class="hidden h-screen flex items-center justify-center px-4 overflow-hidden bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 theme-light:from-slate-50 theme-light:via-slate-100 theme-light:to-slate-50 relative">
      <button id="themeToggleSelector" class="absolute top-4 right-4 p-3 text-slate-300 dark:text-slate-300 theme-light:text-slate-700 hover:text-white dark:hover:text-white theme-light:hover:text-slate-900 hover:bg-slate-700/50 dark:hover:bg-slate-700/50 theme-light:hover:bg-slate-200/50 rounded-lg transition-colors duration-200 z-20" title="Cambiar tema">🌗</button>
      <div class="w-full max-w-4xl">
        <div class="text-center mb-6">
          <h1 class="text-2xl sm:text-3xl font-bold text-white dark:text-white theme-light:text-slate-900 mb-2">Seleccionar Empresa</h1>
          <p class="text-sm text-slate-300 dark:text-slate-300 theme-light:text-slate-600">Elige la empresa con la que deseas trabajar</p>
        </div>
        <div id="companiesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Las empresas se cargarán aquí dinámicamente -->
        </div>
        <div class="text-center mt-6">
          <button id="backToAdmin" class="px-4 py-2 text-sm bg-slate-700/50 dark:bg-slate-700/50 theme-light:bg-sky-50 theme-light:border-2 theme-light:border-slate-300 hover:bg-slate-700 dark:hover:bg-slate-700 theme-light:hover:bg-slate-50 text-white dark:text-white theme-light:text-slate-900 font-semibold rounded-lg transition-all duration-200">Volver al panel admin</button>
        </div>
      </div>
    </section>

    <!-- Vista completa de empresa (igual que index.html) -->
    <section id="appSection" class="hidden w-full">
      <!-- Esta sección se llenará dinámicamente con el contenido de la empresa seleccionada -->
    </section>
  </main>

  <script type="module">
  import { API } from './assets/js/api.esm.js';
  const LS_KEY = 'adm:token';
  function setToken(t){ try{ localStorage.setItem(LS_KEY, t||''); }catch{} }
  function getToken(){ try{ return localStorage.getItem(LS_KEY)||''; }catch{return '';} }
  async function req(path, opts={}){
    const tok = getToken();
    const headers = { 'Content-Type':'application/json', ...(tok?{Authorization:'Bearer '+tok}:{}) };
    const res = await fetch((API.base||'')+path, { ...opts, headers, body: opts.body?JSON.stringify(opts.body):undefined });
    const txt = await res.text(); let data; try{ data=JSON.parse(txt);}catch{ data=txt; }
    if(!res.ok) throw new Error(data?.error || res.statusText);
    return data;
  }
  const loginSec = document.getElementById('loginSection');
  const companySelectorSec = document.getElementById('companySelectorSection');
  const appSec = document.getElementById('appSection');
  const header = document.getElementById('appHeader');
  const emailLbl = document.getElementById('adminEmail');
  const logoutBtn = document.getElementById('adminLogout');
  let currentRole = null;
  let companiesList = [];
  let currentCompanyToken = null;
  let currentCompanyData = null;

  async function enterDashboard(user, fallbackEmail){
    currentRole = user?.role || 'admin';
    emailLbl.textContent = user?.email || fallbackEmail || '-';
    loginSec.classList.add('hidden');
    companySelectorSec.classList.remove('hidden');
    loadCompaniesForSelector();
  }

  document.getElementById('a-login').onclick = async ()=>{
    const email = document.getElementById('a-email').value.trim().toLowerCase();
    const password = document.getElementById('a-password').value;
    try{
      const r = await req('/api/v1/admin/auth/login', { method:'POST', body:{ email, password } });
      setToken(r.token);
      await enterDashboard(r.user, email);
    }catch(e){ alert(e.message||'Error'); }
  };

  // Signup flow: request and confirm
  document.getElementById('s-request').onclick = async ()=>{
    const email = document.getElementById('s-email').value.trim().toLowerCase();
    const msg = document.getElementById('s-msg');
    msg.textContent = '';
    try{
      await req('/api/v1/admin/signup/request', { method:'POST', body:{ email } });
      msg.textContent = 'Solicitud enviada. Contacta al developer para recibir tu codigo.';
    }catch(e){ msg.textContent = e.message||'Error'; }
  };
  document.getElementById('s-confirm').onclick = async ()=>{
    const email = document.getElementById('s-email').value.trim().toLowerCase();
    const code = document.getElementById('s-code').value.trim();
    const password = document.getElementById('s-pass').value;
    const msg = document.getElementById('s-msg');
    msg.textContent='';
    try{
      const r = await req('/api/v1/admin/signup/confirm', { method:'POST', body:{ email, code, password } });
      setToken(r.token);
      await enterDashboard(r.user, email);
    }catch(e){ msg.textContent = e.message||'Error'; }
  };

  // Logout - delegar a la función correcta según el contexto
  function handleLogout(){
    setToken('');
    currentRole = null;
    emailLbl.textContent = '-';
    appSec.classList.add('hidden');
    companySelectorSec.classList.add('hidden');
    if(header) header.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    currentCompanyToken = null;
    currentCompanyData = null;
    API.setActiveCompany('');
    // Limpiar contexto de admin del sessionStorage
    try {
      sessionStorage.removeItem('admin:context');
      sessionStorage.removeItem('admin:email');
      sessionStorage.removeItem('admin:token');
      sessionStorage.removeItem('admin:company');
    } catch {}
    // Remover barra de admin si existe
    const adminBar = document.getElementById('adminIndicatorBar');
    if (adminBar) {
      adminBar.remove();
      document.body.style.paddingTop = '';
      if (header) {
        header.style.marginTop = '';
      }
    }
    loginSec.classList.remove('hidden');
  }
  
  // El logoutBtn original se maneja en setupAdminNavigation

  async function loadCompanies(){
    const tbody = document.getElementById('adm-body');
    tbody.innerHTML = '<tr><td colspan="5" class="t-center">Cargando...</td></tr>';
    try{
      const r = await req('/api/v1/admin/companies');
      const companies = r.items || [];
      const role = currentRole || r.role || 'admin';
      tbody.innerHTML='';
      if(!companies.length){
        tbody.innerHTML = '<tr><td colspan="5" class="t-center muted">Sin empresas asignadas</td></tr>';
        return;
      }
      companies.forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.name || '-'}</td><td>${c.email || '-'}</td><td>${c.active ? 'Si' : 'No'}</td><td class="adm-features"></td><td class="adm-actions"></td>`;
        const featuresTd = tr.querySelector('.adm-features');
        const actionsTd = tr.querySelector('.adm-actions');
        if(role === 'developer'){
          const list = document.createElement('div');
          list.className = 'row wrap';
          list.style.gap = '6px';
          const feats = c.features || {};
          Object.keys(feats).forEach(k=>{
            const label = document.createElement('label');
            label.className = 'chip';
            label.innerHTML = `<input type="checkbox" data-feature="${k}" ${feats[k] !== false ? 'checked' : ''}/> ${k}`;
            list.appendChild(label);
          });
          featuresTd.appendChild(list);
        }else{
          featuresTd.innerHTML = '<span>Funciones disponibles</span>';
        }

        const actions = document.createElement('div');
        actions.className = 'row wrap';
        actions.style.gap = '6px';

        if(role === 'developer'){
          const saveFeatures = document.createElement('button');
          saveFeatures.className = 'secondary';
          saveFeatures.textContent = 'Guardar features';
          saveFeatures.onclick = async ()=>{
            const patch = {};
            featuresTd.querySelectorAll('input[data-feature]').forEach(ch => {
              patch[ch.dataset.feature] = ch.checked;
            });
            try{
              await req(`/api/v1/admin/company/companies/${c._id}/features`, { method:'PATCH', body: patch });
              alert('Features guardados');
            }catch(e){ alert(e.message||'Error'); }
          };
          actions.appendChild(saveFeatures);

          // Restricciones removidas - no hay botón de guardar restricciones
        }

        actionsTd.appendChild(actions);
        tbody.appendChild(tr);
      });
    }catch(e){
      tbody.innerHTML = `<tr><td colspan='5' class='t-center'>${e.message||'Error'}</td></tr>`;
    }
  }
  document.getElementById('loadCompanies').onclick = loadCompanies;

  // Cargar empresas para el selector
  async function loadCompaniesForSelector(){
    const grid = document.getElementById('companiesGrid');
    grid.innerHTML = '<div class="col-span-full text-center text-slate-400">Cargando empresas...</div>';
    try{
      const r = await req('/api/v1/admin/companies');
      companiesList = r.items || [];
      grid.innerHTML = '';
      if(!companiesList.length){
        grid.innerHTML = '<div class="col-span-full text-center text-slate-400">No hay empresas disponibles</div>';
        return;
      }
      companiesList.forEach(c => {
        const card = document.createElement('div');
        card.className = 'bg-slate-800/50 dark:bg-slate-800/50 theme-light:bg-sky-50/90 rounded-xl shadow-xl border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300/50 p-5 hover:shadow-2xl transition-all duration-300 cursor-pointer';
        card.innerHTML = `
          <h3 class="text-lg font-bold text-white dark:text-white theme-light:text-slate-900 mb-2">${c.name || '-'}</h3>
          <p class="text-sm text-slate-400 dark:text-slate-400 theme-light:text-slate-600 mb-3">${c.email || '-'}</p>
          <div class="flex items-center gap-2">
            <span class="px-2 py-1 text-xs rounded-full ${c.active ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">${c.active ? 'Activa' : 'Inactiva'}</span>
          </div>
        `;
        card.onclick = () => selectCompany(c);
        grid.appendChild(card);
      });
    }catch(e){
      grid.innerHTML = `<div class="col-span-full text-center text-red-400">Error: ${e.message}</div>`;
    }
  }

  // Seleccionar empresa y cargar vista completa
  async function selectCompany(company){
    try{
      // Obtener token de impersonación
      const r = await req(`/api/v1/admin/impersonate/${company._id}`, { method: 'POST' });
      currentCompanyToken = r.token;
      currentCompanyData = r.company;
      
      // Guardar token de empresa en API
      API.setActiveCompany(company.email);
      API.token.set(r.token, company.email);
      if(company._id) {
        try {
          const companyIdKey = `taller.companyId:${window.__SCOPE || 'local'}:${company.email.toLowerCase()}`;
          localStorage.setItem(companyIdKey, String(company._id));
        } catch {}
      }
      
      // Guardar features
      if(r.company.features) {
        try {
          const featuresKey = `taller.features:${window.__SCOPE || 'local'}:${company.email.toLowerCase()}`;
          localStorage.setItem(featuresKey, JSON.stringify(r.company.features));
        } catch {}
      }
      
      // Ocultar selector y mostrar vista de empresa
      companySelectorSec.classList.add('hidden');
      await loadCompanyView();
    }catch(e){
      alert('Error al seleccionar empresa: ' + e.message);
    }
  }

  // Botón volver al selector
  document.getElementById('backToAdmin').onclick = () => {
    appSec.classList.add('hidden');
    if(header) header.classList.add('hidden');
    companySelectorSec.classList.remove('hidden');
    currentCompanyToken = null;
    currentCompanyData = null;
    // Limpiar token de empresa
    API.setActiveCompany('');
  };

  // Cargar vista completa de empresa (igual que index.html)
  async function loadCompanyView(){
    // Limpiar appSection
    appSec.innerHTML = '';
    appSec.classList.remove('hidden');
    
    // Crear header completo (similar a index.html) con indicador de admin
    const adminEmail = emailLbl?.textContent || '-';
    const headerHTML = `
      <div class="topbar" id="appHeader">
        <!-- Barra superior con indicador de admin -->
        <div class="bg-slate-900 border-b border-slate-700/50">
          <div class="w-full px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-10">
              <div class="flex items-center gap-2">
                <span class="text-xs text-purple-400 font-semibold">⚙️ ADMIN:</span>
                <span class="text-xs text-slate-300">${adminEmail}</span>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 border-b border-slate-700/50 shadow-lg">
          <div class="w-full px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 md:h-20">
              <div class="flex items-center gap-3 md:gap-4 flex-shrink-0">
                <img id="brandLogo" src="assets/lightlogo.png" alt="M&M logo" class="h-8 md:h-10 w-auto object-contain" />
                <div class="hidden sm:flex flex-col">
                  <span class="text-xs text-slate-400 font-medium">Empresa</span>
                  <span id="companyName" class="text-sm md:text-base font-semibold text-white">${currentCompanyData?.name || currentCompanyData?.email || '-'}</span>
                </div>
                <div class="sm:hidden text-white font-semibold text-sm">
                  <span id="companyNameMobile">${currentCompanyData?.name || currentCompanyData?.email || '-'}</span>
                </div>
              </div>
              <div class="hidden md:flex items-center gap-2">
                <button id="switchCompany" class="px-4 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors duration-200">Cambiar empresa</button>
                <button id="logoutBtn" class="px-4 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors duration-200">Salir</button>
                <button id="openPublicCatalog" class="px-4 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors duration-200" title="Abrir catálogo público">📚 Catálogo</button>
                <button id="themeToggle" class="p-2 text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors duration-200" title="Cambiar tema">🌗</button>
              </div>
              <div class="md:hidden flex items-center gap-2">
                <button id="openPublicCatalog" class="p-2 text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors duration-200" title="Abrir catálogo público">📚</button>
                <button id="themeToggle" class="p-2 text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors duration-200" title="Cambiar tema">🌗</button>
                <button id="mobileMenuToggle" class="p-2 text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors duration-200" aria-label="Menú">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <div class="hidden md:block bg-slate-800/50 border-t border-slate-700/30">
            <div class="w-full px-4 sm:px-6 lg:px-8">
              <nav class="flex items-center gap-1 overflow-x-auto" style="scrollbar-width: thin; scrollbar-color: rgba(148,163,184,0.5) transparent;">
                <button data-tab="home" data-href="index.html" class="nav-tab active px-4 py-3 text-sm font-medium text-white bg-blue-600 rounded-t-lg transition-all duration-200 hover:bg-blue-700 whitespace-nowrap">Inicio</button>
                <button data-tab="notas" data-feature="notas" data-href="notas.html" class="nav-tab px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-t-lg transition-all duration-200 whitespace-nowrap">Notas</button>
                <button data-tab="ventas" data-feature="ventas" data-href="ventas.html" class="nav-tab px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-t-lg transition-all duration-200 whitespace-nowrap">Ventas</button>
                <button data-tab="cotizaciones" data-feature="cotizaciones" data-href="cotizaciones.html" class="nav-tab px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-t-lg transition-all duration-200 whitespace-nowrap">Cotizaciones</button>
                <button data-tab="inventario" data-feature="inventario" data-href="inventario.html" class="nav-tab px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-t-lg transition-all duration-200 whitespace-nowrap">Inventario</button>
                <button data-tab="precios" data-feature="precios" data-href="precios.html" class="nav-tab px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-t-lg transition-all duration-200 whitespace-nowrap">Lista de precios</button>
                <button data-tab="cashflow" data-feature="cashflow" data-href="cashflow.html" class="nav-tab px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-t-lg transition-all duration-200 whitespace-nowrap">Flujo de Caja</button>
                <button data-tab="cartera" data-feature="receivables" data-href="cartera.html" class="nav-tab px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-t-lg transition-all duration-200 whitespace-nowrap">Cartera</button>
                <button data-tab="pendientes" data-href="vehiculos-pendientes.html" class="nav-tab px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-t-lg transition-all duration-200 whitespace-nowrap">⚠️ Pendientes</button>
                <button data-tab="nomina" data-feature="payroll" data-href="nomina.html" class="nav-tab px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-t-lg transition-all duration-200 whitespace-nowrap">Nómina</button>
                <button data-tab="formatos" data-feature="templates" data-href="template-selector.html" class="nav-tab px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-t-lg transition-all duration-200 whitespace-nowrap">Formatos</button>
                <button data-tab="skus" data-feature="skus" data-href="skus.html" class="nav-tab px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-t-lg transition-all duration-200 whitespace-nowrap">SKUs</button>
                <button data-tab="admin" class="nav-tab px-4 py-3 text-sm font-bold text-white bg-purple-600 hover:bg-purple-700 rounded-t-lg transition-all duration-200 whitespace-nowrap border-2 border-purple-400 shadow-lg">⚙️ ADMIN</button>
              </nav>
            </div>
          </div>
        </div>
        <div id="mobileMenu" class="md:hidden hidden bg-slate-800 border-t border-slate-700/50 shadow-xl">
          <div class="px-4 py-3 space-y-1">
            <button data-tab="home" data-href="index.html" class="mobile-nav-tab active w-full text-left px-4 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg transition-all duration-200">Inicio</button>
            <button data-tab="notas" data-feature="notas" data-href="notas.html" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200">Notas</button>
            <button data-tab="ventas" data-feature="ventas" data-href="ventas.html" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200">Ventas</button>
            <button data-tab="cotizaciones" data-feature="cotizaciones" data-href="cotizaciones.html" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200">Cotizaciones</button>
            <button data-tab="inventario" data-feature="inventario" data-href="inventario.html" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200">Inventario</button>
            <button data-tab="precios" data-feature="precios" data-href="precios.html" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200">Lista de precios</button>
            <button data-tab="cashflow" data-feature="cashflow" data-href="cashflow.html" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200">Flujo de Caja</button>
            <button data-tab="cartera" data-feature="receivables" data-href="cartera.html" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200">Cartera</button>
            <button data-tab="pendientes" data-href="vehiculos-pendientes.html" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200">⚠️ Pendientes</button>
            <button data-tab="nomina" data-feature="payroll" data-href="nomina.html" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200">Nómina</button>
            <button data-tab="formatos" data-feature="templates" data-href="template-selector.html" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200">Formatos</button>
            <button data-tab="skus" data-feature="skus" data-href="skus.html" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200">SKUs</button>
            <button data-tab="admin" class="mobile-nav-tab w-full text-left px-4 py-3 text-sm font-bold text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-all duration-200 border-2 border-purple-400">⚙️ ADMIN</button>
            <button id="logoutBtnMobile" class="hidden w-full text-left px-4 py-3 text-sm font-medium text-red-400 hover:text-red-300 hover:bg-red-900/20 rounded-lg transition-all duration-200 mt-2 border-t border-slate-700/50 pt-3">Salir</button>
          </div>
        </div>
      </div>
    `;
    
    // Insertar header antes de appSection
    appSec.insertAdjacentHTML('beforebegin', headerHTML);
    
    // Cargar scripts necesarios si no están cargados
    if(!window.adminScriptsLoaded){
      await loadAdminScripts();
      window.adminScriptsLoaded = true;
    }
    
    // Cargar contenido inicial (pestaña Inicio)
    await loadTabContent('home');
    
    // Configurar navegación
    setupAdminNavigation();
    
    // Mostrar header
    const newHeader = document.getElementById('appHeader');
    if(newHeader) newHeader.classList.remove('hidden');
  }

  // Cargar scripts necesarios
  async function loadAdminScripts(){
    return new Promise((resolve) => {
      const scripts = [
        { src: './assets/js/app.js', type: 'module' },
        { src: './assets/js/notes.js', type: 'module' },
        { src: './assets/js/quotes.js', type: 'module' },
        { src: './assets/js/sales.js', type: 'module' },
        { src: './assets/js/cashflow.js', type: 'module' },
        { src: './assets/js/prices.js', type: 'module' },
        { src: './assets/js/inventory.js', type: 'module' },
        { src: './assets/js/templates.js' },
        { src: './assets/js/input-fix.js' }
      ];
      
      let loaded = 0;
      scripts.forEach(({src, type}) => {
        const script = document.createElement('script');
        if(type === 'module') script.type = 'module';
        script.src = src;
        script.onload = () => {
          loaded++;
          if(loaded === scripts.length) resolve();
        };
        script.onerror = () => {
          loaded++;
          if(loaded === scripts.length) resolve();
        };
        document.head.appendChild(script);
      });
    });
  }

  // Configurar navegación de pestañas
  function setupAdminNavigation(){
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const tab = btn.dataset.tab;
        if(!tab) return;
        e.preventDefault();
        
        // Actualizar pestañas activas
        document.querySelectorAll('.nav-tab, .mobile-nav-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Cargar contenido de la pestaña
        if(tab === 'admin'){
          await loadAdminTab();
        } else {
          const href = btn.dataset.href;
          if(href && href !== 'index.html'){
            // Guardar contexto de admin en sessionStorage antes de navegar
            try {
              sessionStorage.setItem('admin:context', 'true');
              sessionStorage.setItem('admin:token', currentCompanyToken || '');
              sessionStorage.setItem('admin:email', emailLbl?.textContent || adminEmail || '');
              sessionStorage.setItem('admin:company', JSON.stringify(currentCompanyData || {}));
            } catch(e) {
              console.warn('Error guardando contexto admin:', e);
            }
            // Navegar directamente a la página
            window.location.href = href;
          } else {
            await loadTabContent(tab);
          }
        }
      });
    });
    
    // Menú móvil toggle
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    if(mobileMenuToggle && mobileMenu){
      mobileMenuToggle.onclick = () => {
        mobileMenu.classList.toggle('hidden');
      };
    }
    
    // Botón cambiar empresa
    const switchCompanyBtn = document.getElementById('switchCompany');
    if(switchCompanyBtn){
      switchCompanyBtn.onclick = () => {
        appSec.classList.add('hidden');
        const headerEl = document.getElementById('appHeader');
        if(headerEl) headerEl.classList.add('hidden');
        companySelectorSec.classList.remove('hidden');
      };
    }
    
    // Botón logout
    const logoutBtnEl = document.getElementById('logoutBtn');
    const logoutBtnMobileEl = document.getElementById('logoutBtnMobile');
    if(logoutBtnEl) logoutBtnEl.onclick = handleLogout;
    if(logoutBtnMobileEl) logoutBtnMobileEl.onclick = handleLogout;
  }

  // Cargar contenido de pestaña
  async function loadTabContent(tab){
    if(tab === 'home'){
      // Cargar contenido de inicio similar a index.html - usando todo el ancho
      appSec.innerHTML = `
        <section id="tab-home" class="tab active w-full">
          <div class="flex items-center justify-center px-4 py-6 sm:py-8 w-full">
            <div class="w-full max-w-6xl">
              <div class="bg-gradient-to-br from-slate-800 via-slate-800 to-slate-900 rounded-2xl shadow-2xl border border-slate-700/50 p-6 sm:p-8 lg:p-10 text-center relative overflow-hidden">
                <div class="absolute inset-0 opacity-10">
                  <div class="absolute top-0 left-0 w-64 h-64 bg-blue-500 rounded-full blur-3xl"></div>
                  <div class="absolute bottom-0 right-0 w-64 h-64 bg-purple-500 rounded-full blur-3xl"></div>
                </div>
                <div class="relative z-10">
                  <div class="mb-4 flex justify-center">
                    <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg">
                      <svg class="w-8 h-8 sm:w-10 sm:h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                    </div>
                  </div>
                  <h2 class="text-base sm:text-lg text-slate-400 font-medium mb-1">Bienvenido a</h2>
                  <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-3 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                    <span id="welcomeCompany">${currentCompanyData?.name || currentCompanyData?.email || 'Tu empresa'}</span>
                  </h1>
                  <p class="text-sm sm:text-base text-slate-300 mb-6 max-w-md mx-auto">
                    Usa la barra de navegación para acceder a cada herramienta de tu taller.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </section>
      `;
    } else {
      // Para otras pestañas, mostrar mensaje
      appSec.innerHTML = `<div class="w-full px-4 py-6 text-center text-slate-400">Selecciona una pestaña de la barra de navegación para acceder a ${tab}</div>`;
    }
  }

  // Cargar pestaña ADMIN
  async function loadAdminTab(){
    const company = companiesList.find(c => c._id === currentCompanyData?.id || c.email === currentCompanyData?.email);
    if(!company) return;
    
    // Recargar lista de empresas para el selector de BD compartida
    const allCompanies = companiesList.filter(c => c._id !== company._id);
    
    // Lista de todas las pestañas disponibles
    const allTabs = [
      { id: 'notas', name: 'Notas', feature: 'notas' },
      { id: 'ventas', name: 'Ventas', feature: 'ventas' },
      { id: 'cotizaciones', name: 'Cotizaciones', feature: 'cotizaciones' },
      { id: 'inventario', name: 'Inventario', feature: 'inventario' },
      { id: 'precios', name: 'Lista de precios', feature: 'precios' },
      { id: 'cashflow', name: 'Flujo de Caja', feature: 'cashflow' },
      { id: 'cartera', name: 'Cartera', feature: 'receivables' },
      { id: 'pendientes', name: 'Pendientes', feature: null },
      { id: 'nomina', name: 'Nómina', feature: 'payroll' },
      { id: 'formatos', name: 'Formatos', feature: 'templates' },
      { id: 'skus', name: 'SKUs', feature: 'skus' }
    ];
    
    const hiddenTabs = company.restrictions?.hiddenTabs || [];
    const hiddenAccounts = company.restrictions?.cashflow?.hiddenAccounts || [];
    
    appSec.innerHTML = `
      <div class="w-full px-4 sm:px-6 lg:px-8 py-6 space-y-6 flex justify-center">
        <div class="w-full max-w-4xl">
          <div class="bg-slate-800/50 dark:bg-slate-800/50 theme-light:bg-sky-50/90 rounded-xl shadow-lg border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300/50 p-6 sm:p-8">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
              <div class="flex-1">
                <h3 class="text-xl sm:text-2xl font-bold text-white dark:text-white theme-light:text-slate-900 mb-1">Configuración de Empresa</h3>
                <p class="text-sm text-slate-400 dark:text-slate-400 theme-light:text-slate-600">${company.name || company.email}</p>
              </div>
              <button id="saveAllChanges" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-600 dark:to-purple-700 theme-light:from-purple-500 theme-light:to-purple-600 hover:from-purple-700 hover:to-purple-800 dark:hover:from-purple-700 dark:hover:to-purple-800 theme-light:hover:from-purple-600 theme-light:hover:to-purple-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 whitespace-nowrap">💾 Guardar todos los cambios</button>
            </div>
          
          <!-- Features (Funciones) -->
          <div class="mb-6">
            <h4 class="text-lg font-semibold text-white dark:text-white theme-light:text-slate-900 mb-3">Features (Funciones)</h4>
            <p class="text-sm text-slate-400 dark:text-slate-400 theme-light:text-slate-600 mb-4">Activa o desactiva las funciones disponibles para esta empresa:</p>
            <div id="adminFeaturesList" class="flex flex-wrap gap-3 justify-center sm:justify-start">
              ${Object.keys(company.features || {}).map(k => `
                <label class="flex items-center gap-2 px-3 py-2 bg-slate-700/30 dark:bg-slate-700/30 theme-light:bg-white rounded-lg cursor-pointer hover:bg-slate-700/50 dark:hover:bg-slate-700/50 theme-light:hover:bg-slate-100 transition-colors">
                  <input type="checkbox" data-feature="${k}" ${company.features[k] !== false ? 'checked' : ''} class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"/>
                  <span class="text-sm text-white dark:text-white theme-light:text-slate-900">${k}</span>
                </label>
              `).join('')}
            </div>
          </div>
          
          <!-- Ocultar Pestañas -->
          <div class="mb-6 border-t border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300/50 pt-6">
            <h4 class="text-lg font-semibold text-white dark:text-white theme-light:text-slate-900 mb-3">👁️ Ocultar Pestañas</h4>
            <p class="text-sm text-slate-400 dark:text-slate-400 theme-light:text-slate-600 mb-4">Selecciona las pestañas que quieres ocultar para esta empresa:</p>
            <div id="adminHiddenTabsList" class="flex flex-wrap gap-3 justify-center sm:justify-start">
              ${allTabs.map(tab => `
                <label class="flex items-center gap-2 px-3 py-2 bg-slate-700/30 dark:bg-slate-700/30 theme-light:bg-white rounded-lg cursor-pointer hover:bg-slate-700/50 dark:hover:bg-slate-700/50 theme-light:hover:bg-slate-100 transition-colors">
                  <input type="checkbox" data-tab="${tab.id}" ${hiddenTabs.includes(tab.id) ? 'checked' : ''} class="w-4 h-4 text-red-600 rounded focus:ring-red-500"/>
                  <span class="text-sm text-white dark:text-white theme-light:text-slate-900">${tab.name}</span>
                </label>
              `).join('')}
            </div>
          </div>
          
          <!-- Compartir Base de Datos -->
          <div class="mb-6 border-t border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300/50 pt-6">
            <h4 class="text-lg font-semibold text-white dark:text-white theme-light:text-slate-900 mb-3">🔗 Compartir Base de Datos</h4>
            <p class="text-sm text-slate-400 dark:text-slate-400 theme-light:text-slate-600 mb-4">Selecciona una empresa con la que compartir base de datos y agenda. Esta empresa usará los mismos datos que la empresa seleccionada.</p>
            <div class="flex items-center gap-3 max-w-2xl">
              <select id="sharedDatabaseSelect" class="flex-1 px-4 py-2 bg-slate-900/50 dark:bg-slate-900/50 theme-light:bg-white border border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300 rounded-lg text-white dark:text-white theme-light:text-slate-900 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="">-- Sin compartir --</option>
                ${allCompanies.map(c => `
                  <option value="${c._id}" ${String(company.sharedDatabaseId) === String(c._id) ? 'selected' : ''}>${c.name || c.email}</option>
                `).join('')}
              </select>
            </div>
            ${company.sharedDatabaseId ? `
              <div class="mt-3 p-3 bg-yellow-600/20 dark:bg-yellow-600/20 theme-light:bg-yellow-50 rounded-lg border border-yellow-600/30">
                <p class="text-sm text-yellow-400 dark:text-yellow-400 theme-light:text-yellow-600">
                  ⚠️ Esta empresa está compartiendo base de datos con: <strong>${allCompanies.find(c => String(c._id) === String(company.sharedDatabaseId))?.name || company.sharedDatabaseId}</strong>
                </p>
              </div>
            ` : ''}
          </div>
          
          <!-- Toggle Movimientos de Caja -->
          <div class="border-t border-slate-700/50 dark:border-slate-700/50 theme-light:border-slate-300/50 pt-6">
            <h4 class="text-lg font-semibold text-white dark:text-white theme-light:text-slate-900 mb-3">💰 Ocultar Movimientos de Caja</h4>
            <p class="text-sm text-slate-400 dark:text-slate-400 theme-light:text-slate-600 mb-4">Cargando cuentas...</p>
            <div id="adminCashflowAccountsList" class="flex flex-wrap gap-3 justify-center sm:justify-start">
              <!-- Se cargará dinámicamente -->
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Cargar cuentas de flujo de caja
    try {
      const cashflowReq = await fetch(`${API.base || ''}/api/v1/cashflow/accounts`, {
        headers: {
          'Authorization': `Bearer ${currentCompanyToken}`,
          'Content-Type': 'application/json'
        }
      });
      if (cashflowReq.ok) {
        const cashflowData = await cashflowReq.json();
        const accounts = cashflowData.accounts || [];
        const accountsListEl = document.getElementById('adminCashflowAccountsList');
        const accountsDescEl = accountsListEl?.previousElementSibling;
        
        if (accountsListEl && accounts.length > 0) {
          if (accountsDescEl) {
            accountsDescEl.textContent = 'Selecciona las cuentas cuyos movimientos quieres ocultar:';
          }
          accountsListEl.innerHTML = accounts.map(acc => `
            <label class="flex items-center gap-2 px-3 py-2 bg-slate-700/30 dark:bg-slate-700/30 theme-light:bg-white rounded-lg cursor-pointer hover:bg-slate-700/50 dark:hover:bg-slate-700/50 theme-light:hover:bg-slate-100 transition-colors">
              <input type="checkbox" data-account-id="${acc._id || acc.id}" data-account-name="${acc.name || ''}" ${hiddenAccounts.includes(String(acc._id || acc.id)) ? 'checked' : ''} class="w-4 h-4 text-red-600 rounded focus:ring-red-500"/>
              <span class="text-sm text-white dark:text-white theme-light:text-slate-900">${acc.name || 'Sin nombre'}</span>
            </label>
          `).join('');
        } else if (accountsDescEl) {
          accountsDescEl.textContent = 'No hay cuentas disponibles.';
        }
      }
    } catch(e) {
      console.warn('Error cargando cuentas:', e);
      const accountsDescEl = document.getElementById('adminCashflowAccountsList')?.previousElementSibling;
      if (accountsDescEl) {
        accountsDescEl.textContent = 'Error al cargar cuentas.';
      }
    }
    
    // Guardar todos los cambios
    document.getElementById('saveAllChanges').onclick = async () => {
      try {
        // Guardar features
        const featuresPatch = {};
        document.querySelectorAll('#adminFeaturesList input[data-feature]').forEach(ch => {
          featuresPatch[ch.dataset.feature] = ch.checked;
        });
        await req(`/api/v1/admin/company/companies/${company._id}/features`, { method:'PATCH', body: featuresPatch });
        
        // Preparar todas las restrictions en una sola llamada para evitar sobrescritura
        const hiddenTabsArray = [];
        document.querySelectorAll('#adminHiddenTabsList input[data-tab]:checked').forEach(ch => {
          hiddenTabsArray.push(ch.dataset.tab);
        });
        
        const hiddenAccountsArray = [];
        document.querySelectorAll('#adminCashflowAccountsList input[data-account-id]:checked').forEach(ch => {
          hiddenAccountsArray.push(String(ch.dataset.accountId));
        });
        
        // Guardar todas las restrictions en una sola llamada
        const restrictionsPatch = {
          hiddenTabs: hiddenTabsArray,
          cashflow: {
            hiddenAccounts: hiddenAccountsArray
          }
        };
        await req(`/api/v1/admin/company/companies/${company._id}/restrictions`, { 
          method:'PATCH', 
          body: restrictionsPatch
        });
        
        // Guardar BD compartida
        const sharedDbSelect = document.getElementById('sharedDatabaseSelect');
        const sharedDbId = sharedDbSelect?.value || '';
        // Enviar null si está vacío, o el ID si tiene valor
        await req(`/api/v1/admin/company/companies/${company._id}/shared-database`, { 
          method:'PATCH', 
          body: { sharedDatabaseId: sharedDbId === '' ? null : sharedDbId } 
        });
        
        alert('✅ Todos los cambios guardados correctamente');
        
        // Limpiar caché de restrictions para todas las empresas afectadas
        // Esto asegura que cuando la empresa afectada inicie sesión, vea los cambios inmediatamente
        try {
          // Obtener __SCOPE desde config.js o calcularlo
          const __SCOPE = (() => {
            try {
              if (window.__SCOPE) return window.__SCOPE;
              const base = window.API_BASE || window.BACKEND_URL || '';
              if (!base) return 'local';
              try {
                const url = new URL(base);
                return `${url.hostname}${url.port ? ':' + url.port : ''}${url.pathname}`.replace(/\/$/, '') || 'local';
              } catch {
                return base.replace(/^https?:\/\//, '').replace(/\/$/, '') || 'local';
              }
            } catch {
              return 'local';
            }
          })();
          
          const email = company.email || '';
          if(email) {
            localStorage.removeItem(`taller.restrictions:${__SCOPE}:${email.toLowerCase()}`);
          }
          // También limpiar para la empresa compartida si existe
          const finalSharedDbId = sharedDbId === '' ? null : sharedDbId;
          if(finalSharedDbId) {
            const sharedCompany = allCompanies.find(c => c._id === finalSharedDbId);
            if(sharedCompany?.email) {
              localStorage.removeItem(`taller.restrictions:${__SCOPE}:${sharedCompany.email.toLowerCase()}`);
            }
          }
        } catch(e) {
          console.warn('Error limpiando caché:', e);
        }
        
        // Recargar datos de empresa
        const r = await req('/api/v1/admin/companies');
        const updated = r.items.find(c => c._id === company._id);
        if(updated) {
          Object.assign(company, updated);
          await loadAdminTab();
        }
      }catch(e){
        alert('❌ Error: ' + e.message);
      }
    };
  }

  (async ()=>{
    if(!getToken()) return;
    try{
      const me = await req('/api/v1/admin/auth/me');
      await enterDashboard(me.user, me?.user?.email);
    }catch{
      setToken('');
    }
  })();

  // Event listener para botón de cambio de tema en admin
  document.addEventListener('DOMContentLoaded', () => {
    const themeBtn = document.getElementById('themeToggleAdmin');
    if (themeBtn) {
      themeBtn.addEventListener('click', () => {
        const isLight = document.body.classList.contains('theme-light');
        const newTheme = isLight ? 'dark' : 'light';
        
        // Intentar usar applyTheme si está disponible
        if (typeof window.applyTheme === 'function') {
          window.applyTheme(newTheme);
        } else {
          // Fallback manual
          document.body.classList.toggle('theme-light');
          try {
            localStorage.setItem('app:theme', newTheme);
          } catch {}
          // Actualizar icono del botón
          themeBtn.textContent = newTheme === 'light' ? '🌙' : '🌞';
          themeBtn.title = newTheme === 'light' ? 'Cambiar a oscuro' : 'Cambiar a claro';
        }
      });
      
      // Inicializar icono del botón según el tema actual
      const currentTheme = document.body.classList.contains('theme-light') ? 'light' : 'dark';
      themeBtn.textContent = currentTheme === 'light' ? '🌙' : '🌞';
      themeBtn.title = currentTheme === 'light' ? 'Cambiar a oscuro' : 'Cambiar a claro';
    }
    
    // Aplicar tema inicial si está guardado
    try {
      const stored = localStorage.getItem('app:theme');
      if (stored === 'light' || stored === 'dark') {
        if (typeof window.applyTheme === 'function') {
          window.applyTheme(stored);
        } else {
          if (stored === 'light') {
            document.body.classList.add('theme-light');
          } else {
            document.body.classList.remove('theme-light');
          }
          if (themeBtn) {
            themeBtn.textContent = stored === 'light' ? '🌙' : '🌞';
            themeBtn.title = stored === 'light' ? 'Cambiar a oscuro' : 'Cambiar a claro';
          }
        }
      }
    } catch {}
  });
    // Botón del catálogo
    function setupCatalogButton() {
      const btn = document.getElementById('openPublicCatalog');
      if(!btn) return;
      const API = window.API;
      if(!API || !API.token || !API.token.get) {
        setTimeout(setupCatalogButton, 100);
        return;
      }
      const token = API.token.get() || '';
      if(!token){ btn.disabled=true; btn.title='Inicia sesión para usar el catálogo'; return; }
      (API.companyMe ? API.companyMe() : Promise.reject(new Error('API no disponible')))
        .then(body => {
          const company = body?.company || body || {};
          const storedId = API?.companyId?.get?.() || '';
          const companyId = company.id || company._id || storedId || '';
          const enabled = (typeof company.publicCatalogEnabled === 'boolean') ? company.publicCatalogEnabled : true;
          if(!companyId){ btn.disabled=true; btn.title='No se pudo obtener companyId'; return; }
          if(!enabled){ btn.disabled=true; btn.title='Catálogo público deshabilitado'; btn.dataset.state='disabled'; return; }
          btn.dataset.state='ready';
          btn.disabled = false;
          btn.onclick = () => {
            const url = 'catalogo.html?companyId=' + encodeURIComponent(companyId);
            window.open(url, '_blank');
          };
        })
        .catch(()=>{
          const storedId = API?.companyId?.get?.() || '';
          if(storedId){
            btn.dataset.state='ready'; btn.title=''; btn.disabled=false;
            btn.onclick = () => window.open('catalogo.html?companyId=' + encodeURIComponent(storedId), '_blank');
          } else {
            btn.disabled=true; btn.title='Error consultando empresa'; btn.dataset.state='error';
          }
        });
    }
    document.addEventListener('DOMContentLoaded', setupCatalogButton);
    // También intentar después de que los scripts se carguen
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupCatalogButton);
    } else {
      setupCatalogButton();
    }
  </script>
</body>
</html>

