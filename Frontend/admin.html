<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Admin</title>
  <link rel="stylesheet" href="assets/styles.css?v=20251010" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <script src="./assets/js/config.js"></script>
  <script src="./assets/js/api.js"></script>
</head>
<body data-page="admin">
  <div class="topbar hidden" id="appHeader">
    <div class="topbar-inner">
      <div class="topbar-card">
        <div class="row between" style="align-items:center;gap:8px;flex-wrap:wrap;">
          <div class="brand">
            <img id="brandLogo" src="assets/lightlogo.png" alt="M&M logo" />
            <div class="company">Admin: <span id="adminEmail">-</span></div>
          </div>
          <div class="row" style="gap:6px;align-items:center;">
            <button id="adminLogout" class="secondary hidden">Salir</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main>
    <section id="loginSection">
      <div class="card" style="max-width:420px;margin:40px auto;">
        <h2>Ingreso Admin/Developer</h2>
        <label>Correo</label>
        <input id="a-email" type="email" />
        <label>Contraseña</label>
        <input id="a-password" type="password" />
        <div class="row" style="gap:8px;margin-top:8px;">
          <button id="a-login">Entrar</button>
        </div>
      </div>
    </section>

    <section id="appSection" class="hidden">
      <div class="card" style="max-width:1000px;margin:20px auto;">
        <div class="row between" style="align-items:center;gap:8px;flex-wrap:wrap;">
          <h3 style="margin:0;">Empresas</h3>
          <div class="row" style="gap:6px;">
            <button id="loadCompanies" class="secondary">Actualizar</button>
          </div>
        </div>
        <div class="table-wrap" style="margin-top:8px;">
          <table class="table">
            <thead><tr><th>Nombre</th><th>Email</th><th>Activa</th><th>Features</th><th></th></tr></thead>
            <tbody id="adm-body"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
  import { API } from './assets/js/api.esm.js';
  const LS_KEY = 'adm:token';
  function setToken(t){ try{ localStorage.setItem(LS_KEY, t||''); }catch{} }
  function getToken(){ try{ return localStorage.getItem(LS_KEY)||''; }catch{return '';} }
  async function req(path, opts={}){
    const tok = getToken();
    const headers = { 'Content-Type':'application/json', ...(tok?{Authorization:'Bearer '+tok}:{}) };
    const res = await fetch((API.base||'')+path, { ...opts, headers, body: opts.body?JSON.stringify(opts.body):undefined });
    const txt = await res.text(); let data; try{ data=JSON.parse(txt);}catch{ data=txt; }
    if(!res.ok) throw new Error(data?.error || res.statusText);
    return data;
  }
  const loginSec = document.getElementById('loginSection');
  const appSec = document.getElementById('appSection');
  const header = document.getElementById('appHeader');
  const emailLbl = document.getElementById('adminEmail');
  document.getElementById('a-login').onclick = async ()=>{
    const email = document.getElementById('a-email').value.trim().toLowerCase();
    const password = document.getElementById('a-password').value;
    try{
      const r = await req('/api/v1/admin/auth/login', { method:'POST', body:{ email, password } });
      setToken(r.token);
      emailLbl.textContent = r?.user?.email || email;
      loginSec.classList.add('hidden'); appSec.classList.remove('hidden'); header.classList.remove('hidden');
      loadCompanies();
    }catch(e){ alert(e.message||'Error'); }
  };
  async function loadCompanies(){
    const tbody = document.getElementById('adm-body');
    tbody.innerHTML = '<tr><td colspan="5" class="t-center">Cargando...</td></tr>';
    try{
      const r = await req('/api/v1/admin/companies');
      tbody.innerHTML='';
      (r.items||[]).forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.name}</td><td>${c.email}</td><td>${c.active?'Sí':'No'}</td><td><div class='row wrap' style='gap:6px;'>${Object.entries(c.features||{}).map(([k,v])=>`<label class='chip'><input type='checkbox' data-k='${k}' ${v!==false?'checked':''}/> ${k}</label>`).join('')}</div></td><td><button class='save secondary'>Guardar</button></td>`;
        tr.querySelector('.save').onclick = async ()=>{
          const patch = {}; tr.querySelectorAll('input[type=checkbox][data-k]').forEach(ch=>{ patch[ch.dataset.k] = ch.checked; });
          try{ const u = await req(`/api/v1/admin/companies/${c._id}/features`, { method:'PATCH', body: patch }); alert('Guardado'); }catch(e){ alert(e.message||'Error'); }
        };
        tbody.appendChild(tr);
      });
    }catch(e){ tbody.innerHTML = `<tr><td colspan='5' class='t-center'>${e.message||'Error'}</td></tr>`; }
  }
  document.getElementById('loadCompanies').onclick = loadCompanies;
  </script>
</body>
</html>
