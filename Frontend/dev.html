<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Developer</title>
  <link rel="stylesheet" href="assets/styles.css?v=20251010" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <script src="./assets/js/config.js"></script>
  <script src="./assets/js/api.js"></script>
</head>
<body data-page="developer">
  <main>
    <section id="loginSection">
      <div class="card" style="max-width:420px;margin:40px auto;">
        <h2>Ingreso Developer</h2>
        <label>Correo</label>
        <input id="d-email" type="email" />
        <label>Contraseña</label>
        <input id="d-password" type="password" />
        <div class="row" style="gap:8px;margin-top:8px;">
          <button id="d-login">Entrar</button>
        </div>
      </div>
    </section>
    <section id="appSection" class="hidden">
      <div class="card" style="max-width:980px;margin:20px auto;">
        <nav class="tabs" id="devTabs" style="margin-bottom:10px;">
          <button data-t="reqs" class="active">Solicitudes</button>
          <button data-t="companies">Empresas y Funciones</button>
          <button data-t="admins">Admins</button>
        </nav>
        <div class="row between" style="align-items:center;gap:8px;">
          <h3 style="margin:0;">Solicitudes de Admin</h3>
          <button id="d-refresh" class="secondary">Actualizar</button>
        </div>
        <div id="d-list" style="margin-top:10px;"></div>
      </div>
      <div class="card" id="companiesCard" style="max-width:980px;margin:12px auto;display:none;">
        <div class="row between" style="align-items:center;gap:8px;">
          <h3 style="margin:0;">Empresas y Funciones</h3>
          <button id="c-refresh" class="secondary">Actualizar</button>
        </div>
        <div id="c-list" style="margin-top:10px;"></div>
      </div>
      <div class="card" style="max-width:980px;margin:12px auto;" id="adminsCard">
        <div class="row between" style="align-items:center;gap:8px;">
          <h3 style="margin:0;">Admins existentes</h3>
          <button id="a-refresh" class="secondary">Actualizar</button>
        </div>
        <div id="a-list" style="margin-top:10px;"></div>
      </div>
    </section>
  </main>
  <script type="module">
  import { API } from './assets/js/api.esm.js';
  const LS_KEY='dev:token';
  function setTok(t){ try{ localStorage.setItem(LS_KEY, t||''); }catch{} }
  function getTok(){ try{ return localStorage.getItem(LS_KEY)||''; }catch{return '';} }
  async function req(path, opts={}){
    const headers = { 'Content-Type':'application/json' };
    const tok = getTok(); if(tok) headers.Authorization = 'Bearer '+tok;
    const res = await fetch((API.base||'')+path, { ...opts, headers, body: opts.body?JSON.stringify(opts.body):undefined });
    const txt = await res.text(); let data; try{ data=JSON.parse(txt);}catch{ data=txt; }
    if(!res.ok) throw new Error(data?.error || res.statusText);
    return data;
  }
  document.getElementById('d-login').onclick = async ()=>{
    const email = document.getElementById('d-email').value.trim().toLowerCase();
    const password = document.getElementById('d-password').value;
    try{
      const r = await req('/api/v1/admin/auth/login', { method:'POST', body:{ email, password } });
      setTok(r.token);
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('appSection').classList.remove('hidden');
      loadReqs();
    }catch(e){ alert(e.message||'Error'); }
  };
  async function loadReqs(){
    const wrap = document.getElementById('d-list');
    wrap.innerHTML = '<div class="muted">Cargando...</div>';
    try{
      const r = await req('/api/v1/admin/signup/requests');
      wrap.innerHTML = '';
      const companies = r.companies||[];
      (r.items||[]).forEach(item=>{
        const div = document.createElement('div');
        div.className='card'; div.style.marginBottom='8px';
        div.innerHTML = `<div class='row between' style='align-items:center;'>
          <div>
            <div><strong>${item.email}</strong></div>
            <div class='muted' style='font-size:12px;'>Estado: ${item.status}</div>
          </div>
          <div>
            <details>
              <summary>Asignar empresas</summary>
              <div class='row wrap' style='gap:6px;margin-top:6px;'>
                ${companies.map(c=>`<label class='chip'><input type='checkbox' data-c='${c._id}' ${item.assignedCompanies?.some?.(ac=>String(ac?._id||ac)===String(c._id))?'checked':''}/> ${c.name||c.email}</label>`).join('')}
              </div>
            </details>
            <div class='row right' style='gap:6px;margin-top:6px;'>
              <button class='approve'>Aprobar</button>
            </div>
          </div>
        </div>`;
        div.querySelector('.approve').onclick = async ()=>{
          const selected = Array.from(div.querySelectorAll('input[type=checkbox][data-c]:checked')).map(x=>x.dataset.c);
          try{
            const res = await req(`/api/v1/admin/signup/requests/${item._id}/approve`, { method:'POST', body:{ companies: selected } });
            alert(`Código generado: ${res.code}\nCompártelo con el solicitante.`);
            loadReqs();
          }catch(e){ alert(e.message||'Error'); }
        };
        wrap.appendChild(div);
      });
      if(!wrap.children.length){ wrap.innerHTML = '<div class="muted">Sin solicitudes pendientes</div>'; }
    }catch(e){ wrap.innerHTML = `<div class='muted'>${e.message||'Error'}</div>`; }
  }
  document.getElementById('d-refresh').onclick = loadReqs;

  // Admins existentes: listar y editar asignación de empresas
  async function loadAdmins(){
    const wrap = document.getElementById('a-list');
    wrap.innerHTML = '<div class="muted">Cargando...</div>';
    try{
      // Usamos /companies para catálogo, y buscamos admins vía /api/v1/admin/auth/me? (no hay listado). Implementamos llamado directo a un endpoint opcional: de momento, pedimos los admins por email manualmente.
      // Para no ampliar backend más, haremos una llamada simple al servidor que no existe; como sí ampliamos antes, mejor listemos AdminUsers developers y admins: añadimos endpoint rápido.
      const list = await (async()=>{
        try{ const r = await req('/api/v1/admin/admins'); return r.items||[]; }catch{ return []; }
      })();
      const companies = await (async()=>{ try{ const c = await req('/api/v1/admin/companies'); return c.items||[]; }catch{ return []; } })();
      wrap.innerHTML = '';
      if(!list.length){ wrap.innerHTML = '<div class="muted">Aún no hay admins creados o falta endpoint.</div>'; return; }
      list.forEach(u=>{
        const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
        div.innerHTML = `<div class='row between' style='align-items:center;'>
          <div>
            <div><strong>${u.email}</strong> <span class='muted' style='font-size:12px;'>(${u.role})</span></div>
          </div>
          <div style='flex:1;margin:0 12px;'>
            <div class='row wrap' style='gap:6px;'>
              ${companies.map(c=>`<label class='chip'><input type='checkbox' data-c='${c._id}' ${u.companies?.some?.(ac=>String(ac)===String(c._id))?'checked':''}/> ${c.name||c.email}</label>`).join('')}
            </div>
          </div>
          <div>
            <button class='save secondary'>Guardar</button>
          </div>
        </div>`;
        div.querySelector('.save').onclick = async ()=>{
          const selected = Array.from(div.querySelectorAll('input[type=checkbox][data-c]:checked')).map(x=>x.dataset.c);
          try{
            await req(`/api/v1/admin/admins/${u._id}/companies`, { method:'PATCH', body:{ companies: selected } });
            alert('Guardado');
          }catch(e){ alert(e.message||'Error'); }
        };
        wrap.appendChild(div);
      });
    }catch(e){ wrap.innerHTML = `<div class='muted'>${e.message||'Error'}</div>`; }
  }
  document.getElementById('a-refresh').onclick = loadAdmins;

  // ===== Empresas y Funciones =====
  async function loadCompanies(){
    const wrap = document.getElementById('c-list');
    wrap.innerHTML = '<div class="muted">Cargando...</div>';
    try{
      const res = await req('/api/v1/admin/company/companies');
      const items = res.items || [];
      wrap.innerHTML = '';
      items.forEach(c => {
        const id = String(c._id || c.id || '');
        const div = document.createElement('div');
        div.className = 'card'; div.style.marginBottom='10px';
        const feat = c.features || {};
        const fopts = c.featureOptions || {};
        const restr = c.restrictions || {};
        const check = (id, checked) => `<label class='chip'><input type='checkbox' id='${id}' ${checked?'checked':''}/> ${id.split(':').slice(1).join(':')||id}</label>`;
        div.innerHTML = `
          <div class='row between' style='align-items:flex-start;gap:10px;'>
            <div style='min-width:260px;'>
              <div><strong>${c.name || c.email}</strong></div>
              <div class='muted' style='font-size:12px;'>${c.email}</div>
              <div class='muted' style='font-size:12px;'>Activa: ${c.active? 'Sí':'No'}</div>
            </div>
            <div style='flex:1;'>
              <details open>
                <summary><b>Módulos</b></summary>
                <div class='row wrap' style='gap:6px;margin-top:6px;' id='feat-${id}'></div>
                <div class='row right' style='margin-top:6px;'><button class='secondary' data-save-feat>Guardar módulos</button></div>
              </details>
              <details>
                <summary><b>Opciones</b></summary>
                <div id='fopts-${id}' style='display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:8px;margin-top:6px;'></div>
                <div class='row right' style='margin-top:6px;'><button class='secondary' data-save-fopts>Guardar opciones</button></div>
              </details>
              <details>
                <summary><b>Restricciones</b></summary>
                <div class='row wrap' style='gap:6px;margin-top:6px;' id='restr-${id}'></div>
                <div class='row right' style='margin-top:6px;'><button class='secondary' data-save-restr>Guardar restricciones</button></div>
              </details>
            </div>
          </div>`;
        // Render módulos
        const FEATS = ['notas','ventas','cotizaciones','inventario','precios','cashflow','techreport','templates','skus'];
        const wrapFeat = div.querySelector(`#feat-${id}`);
        FEATS.forEach(k=>{
          const cid = `f:${k}`; const enabled = feat[k] !== false;
          wrapFeat.insertAdjacentHTML('beforeend', `<label class='chip'><input type='checkbox' id='${cid}' ${enabled?'checked':''}/> ${k}</label>`);
        });
        // Render opciones
        const fowrap = div.querySelector(`#fopts-${id}`);
        const blocks = {
          ventas: { importarCotizacion:'Importar cotización', ordenesTrabajo:'Órdenes de trabajo' },
          inventario: { ingresoVehiculo:'Ingreso de vehículo', ingresoCompra:'Ingreso de compra', marketplace:'Marketplace', publicar:'Publicación masiva', publicarAgotados:'Despublicar agotados', publicCatalogFields:'Campos de catálogo' },
          templates: { stickerQR:'Sticker: solo QR', stickerMarca:'Sticker: marca', stickerQRyMarca:'Sticker: QR + marca' }
        };
        Object.entries(blocks).forEach(([mod, opts])=>{
          const box = document.createElement('div');
          box.className='card';
          box.innerHTML = `<div><b>${mod}</b></div><div class='row wrap' style='gap:6px;margin-top:6px;'></div>`;
          const row = box.querySelector('.row');
          Object.entries(opts).forEach(([key,label])=>{
            const enabled = (fopts?.[mod]?.[key] !== false);
            const cid = `fo:${mod}:${key}`;
            row.insertAdjacentHTML('beforeend', `<label class='chip'><input type='checkbox' id='${cid}' ${enabled?'checked':''}/> ${label}</label>`);
          });
          fowrap.appendChild(box);
        });
        // Restricciones
        const rwrap = div.querySelector(`#restr-${id}`);
        const hideBalances = !!(restr?.cashflow?.hideBalances);
        rwrap.insertAdjacentHTML('beforeend', `<label class='chip'><input type='checkbox' id='r:cashflow:hideBalances' ${hideBalances?'checked':''}/> Ocultar saldos de cuentas</label>`);

        // Handlers guardar
        div.querySelector('[data-save-feat]').onclick = async ()=>{
          try{
            const payload = {};
            FEATS.forEach(k=>{ const el = div.querySelector(`#f:${k}`); payload[k] = !!el?.checked; });
            const saved = await req(`/api/v1/admin/company/companies/${id}/features`, { method:'PATCH', body: payload });
            alert('Módulos guardados');
          }catch(e){ alert(e.message||'Error'); }
        };
        div.querySelector('[data-save-fopts]').onclick = async ()=>{
          try{
            const payload = { ventas:{}, inventario:{}, templates:{} };
            Object.keys(blocks.ventas).forEach(k=>{ payload.ventas[k] = !!div.querySelector(`#fo:ventas:${k}`)?.checked; });
            Object.keys(blocks.inventario).forEach(k=>{ payload.inventario[k] = !!div.querySelector(`#fo:inventario:${k}`)?.checked; });
            Object.keys(blocks.templates).forEach(k=>{ payload.templates[k] = !!div.querySelector(`#fo:templates:${k}`)?.checked; });
            await req(`/api/v1/admin/company/companies/${id}/feature-options`, { method:'PATCH', body: payload });
            alert('Opciones guardadas');
          }catch(e){ alert(e.message||'Error'); }
        };
        div.querySelector('[data-save-restr]').onclick = async ()=>{
          try{
            const payload = { cashflow: { hideBalances: !!div.querySelector('#r:cashflow:hideBalances')?.checked } };
            await req(`/api/v1/admin/company/companies/${id}/restrictions`, { method:'PATCH', body: payload });
            alert('Restricciones guardadas');
          }catch(e){ alert(e.message||'Error'); }
        };
        wrap.appendChild(div);
      });
      if(!wrap.children.length){ wrap.innerHTML = '<div class="muted">No hay empresas</div>'; }
    }catch(e){ wrap.innerHTML = `<div class='muted'>${e.message||'Error'}</div>`; }
  }

  // Tabs behavior
  const devTabs = document.getElementById('devTabs');
  devTabs?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-t]'); if(!btn) return;
    devTabs.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.t;
    document.querySelector('h3').textContent = t==='reqs' ? 'Solicitudes de Admin' : (t==='companies' ? 'Empresas y Funciones' : 'Admins existentes');
    document.getElementById('companiesCard').style.display = (t==='companies') ? '' : 'none';
    document.getElementById('adminsCard').style.display = (t==='admins') ? '' : '';
    // Toggle first card list and headers
    document.getElementById('d-refresh').parentElement.parentElement.style.display = (t==='reqs') ? '' : 'none';
    if(t==='companies') loadCompanies();
    if(t==='admins') loadAdmins();
    if(t==='reqs') loadReqs();
  });
  </script>
</body>
</html>
