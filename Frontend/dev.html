<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Developer</title>
  <!-- Main CSS - Sistema unificado de estilos -->
  <link rel="stylesheet" href="assets/css/main.css" />
  <link rel="stylesheet" href="assets/styles.css?v=20251010" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <script src="./assets/js/config.js"></script>
  <script src="./assets/js/api.js"></script>
  <style>
    body[data-page="developer"]{
      background:
        radial-gradient(circle at 15% -10%, rgba(79,70,229,0.18), transparent 55%),
        linear-gradient(160deg, rgba(8,145,178,0.18), transparent 60%);
      min-height:100vh;
      margin:0;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    }
    body[data-page="developer"] main{
      padding:32px 16px 64px;
    }
    body[data-page="developer"] .card{
      background:rgba(15,23,42,0.7);
      border:1px solid rgba(148,163,184,0.28);
      color:inherit;
    }
    .dev-main{
      max-width:1100px;
      margin:0 auto;
    }
    .dev-login{
      display:flex;
      justify-content:center;
    }
    .dev-login-card{
      max-width:420px;
      margin:36px auto;
      padding:32px 36px;
      border-radius:20px;
      box-shadow:0 16px 40px rgba(15,23,42,0.28);
    }
    .dev-login-card h2{
      margin-top:0;
      margin-bottom:16px;
      text-align:center;
    }
    .dev-login-card label{
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted, rgba(226,232,240,0.65));
    }
    .dev-login-card input{
      width:100%;
      margin:6px 0 14px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.25);
      background:rgba(15,23,42,0.45);
      color:inherit;
      padding:10px 14px;
      transition:border .2s, box-shadow .2s;
    }
    .dev-login-card input:focus{
      outline:none;
      border-color:var(--accent,#38bdf8);
      box-shadow:0 0 0 2px rgba(56,189,248,0.25);
    }
    body[data-page="developer"] button{
      background:#38bdf8;
      color:#0f172a;
      border:none;
    }
    body[data-page="developer"] button.secondary{
      background:transparent;
      color:inherit;
      border:1px solid rgba(148,163,184,0.28);
    }
    .dev-app{
      animation:fadeIn .45s ease .08s both;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform:translateY(12px); }
      to{ opacity:1; transform:translateY(0); }
    }
    .dev-shell{
      display:grid;
      gap:24px;
    }
    .dev-hero{
      display:flex;
      flex-wrap:wrap;
      gap:24px;
      align-items:flex-start;
      padding:28px 32px;
      border-radius:24px;
      border:1px solid rgba(148,163,184,0.22);
      background:linear-gradient(135deg, rgba(15,23,42,0.85), rgba(30,41,59,0.7));
      box-shadow:0 24px 60px rgba(8,15,35,0.45);
      backdrop-filter:blur(18px);
    }
    .dev-hero h1{
      margin:0 0 8px;
      font-size:2rem;
      letter-spacing:-0.02em;
    }
    .dev-hero p{
      margin:0;
      max-width:520px;
      color:var(--muted, rgba(226,232,240,0.65));
      font-size:0.95rem;
    }
    .dev-hero-text{
      flex:1 1 320px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .dev-stat-grid{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:stretch;
    }
    .dev-stat{
      min-width:150px;
      padding:14px 18px;
      border-radius:16px;
      background:rgba(15,23,42,0.45);
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:0 12px 32px rgba(8,15,35,0.35);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .dev-stat span{
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted, rgba(226,232,240,0.6));
    }
    .dev-stat strong{
      font-size:28px;
      line-height:1;
      color:var(--accent,#38bdf8);
      font-weight:700;
    }
    .dev-section{
      padding:24px 28px;
      border-radius:20px;
      box-shadow:0 18px 44px rgba(8,15,35,0.35);
      border:1px solid rgba(148,163,184,0.18);
      background:rgba(15,23,42,0.55);
      backdrop-filter:blur(12px);
    }
    .dev-section-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      flex-wrap:wrap;
    }
    .dev-section-head h3{
      margin:0;
      font-size:1.35rem;
    }
    .dev-section-head p{
      margin:4px 0 0;
      max-width:520px;
      color:var(--muted, rgba(226,232,240,0.65));
      font-size:0.95rem;
    }
    .dev-head-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    #devTabs{
      display:flex;
      gap:10px;
      margin-bottom:18px;
      background:rgba(15,23,42,0.35);
      border-radius:16px;
      padding:6px;
      border:1px solid rgba(148,163,184,0.18);
    }
    #devTabs button{
      flex:1;
      min-width:160px;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:600;
      color:inherit;
      background:transparent;
      transition:background .2s, box-shadow .2s, transform .2s;
    }
    #devTabs button:hover{
      background:rgba(59,130,246,0.15);
    }
    #devTabs button.active{
      background:linear-gradient(135deg, rgba(79,70,229,0.32), rgba(59,130,246,0.25));
      box-shadow:0 12px 26px rgba(59,130,246,0.35);
      transform:translateY(-1px);
    }
    .dev-toolbar{
      margin-top:16px;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }
    .dev-search{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .dev-search input[type="search"]{
      min-width:240px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.28);
      background:rgba(15,23,42,0.45);
      color:inherit;
      transition:border .2s, box-shadow .2s;
    }
    .dev-search input[type="search"]::placeholder{
      color:var(--muted, rgba(226,232,240,0.55));
      letter-spacing:.01em;
    }
    .dev-search input[type="search"]:focus{
      outline:none;
      border-color:var(--accent,#38bdf8);
      box-shadow:0 0 0 2px rgba(56,189,248,0.25);
    }
    .dev-toolbar-meta{
      display:flex;
      gap:10px;
      align-items:center;
      font-size:13px;
      color:var(--muted, rgba(226,232,240,0.6));
    }
    .dev-toolbar-meta .bullet{
      width:6px;
      height:6px;
      border-radius:50%;
      background:rgba(148,163,184,0.45);
      display:inline-block;
    }
    .dev-grid{
      display:grid;
      gap:16px;
      margin-top:18px;
    }
    .dev-chip-grid{
      display:grid;
      gap:12px;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    }
  </style>
</head>
<body data-page="developer">
  <noscript>
    <div style="background:#1f2937;color:#f8fafc;padding:16px;text-align:center;">
      Activa JavaScript para usar el panel developer.
    </div>
  </noscript>
    <main class="dev-main" style="max-width:1100px;margin:0 auto;padding:32px 16px 64px;">
    <section id="loginSection" class="dev-login" style="display:flex;justify-content:center;align-items:flex-start;">
      <div class="card dev-login-card" style="max-width:440px;width:100%;margin:48px auto;padding:40px;border-radius:24px;box-shadow:0 18px 48px rgba(15,23,42,0.45);background:#0f172a;border:1px solid rgba(148,163,184,0.55);color:#f8fafc;">
        <h1 style="margin:0 0 12px;text-align:center;font-size:28px;">Panel Developer</h1>
        <p style="margin:0 0 24px;text-align:center;color:rgba(226,232,240,0.7);font-size:14px;">Accede con el PIN de desarrollador para administrar la configuración.</p>
        <label style="display:block;font-size:13px;text-transform:uppercase;letter-spacing:.08em;color:rgba(226,232,240,0.78);margin-bottom:6px;">PIN de Desarrollador</label>
        <input id="d-pin" type="password" maxlength="6" placeholder="Ingresa el PIN" style="width:100%;margin:0 0 24px;border-radius:14px;border:1px solid rgba(148,163,184,0.5);background:#1e293b;color:#f8fafc;padding:12px 16px;font-size:15px;text-align:center;letter-spacing:2px;" />
        <button id="d-login" style="width:100%;padding:12px 16px;border-radius:14px;border:none;background:linear-gradient(135deg,#38bdf8,#6366f1);color:#0f172a;font-weight:700;cursor:pointer;box-shadow:0 20px 42px rgba(56,189,248,0.4);">Entrar</button>
        <p style="margin:20px 0 0;text-align:center;font-size:12px;color:rgba(226,232,240,0.6);">Solo el desarrollador tiene acceso a este panel.</p>
      </div>
    </section>
    <section id="appSection" class="hidden dev-app">
      <div class="dev-shell">
        <article class="card dev-hero">
          <div class="dev-hero-text">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h1>Panel de Desarrollo</h1>
            <p>Gestiona solicitudes de creación de cuenta admin.</p>
          </div>
          <div style="display:flex;gap:8px;">
            <button id="dev-logout" style="padding:8px 16px;border-radius:8px;border:1px solid rgba(148,163,184,0.3);background:rgba(239,68,68,0.1);color:#ef4444;cursor:pointer;">Cerrar Sesión</button>
          </div>
        </div>
          </div>
          <div class="dev-stat-grid">
            <div class="dev-stat">
              <span>Solicitudes</span>
              <strong id="stat-requests">0</strong>
            </div>
            <div class="dev-stat">
              <span>Admins</span>
              <strong id="stat-admins">0</strong>
            </div>
          </div>
        </article>

        <article class="card dev-section" id="requestsCard" style="display:none;">
          <nav class="tabs" id="devTabs" style="display:none;">
            <button data-t="reqs" class="active">Solicitudes</button>
            <button data-t="admins">Admins</button>
          </nav>
          <div id="requestsContent">
            <div class="dev-section-head">
              <div>
                <h3>Solicitudes de Admin</h3>
                <p>Aprueba nuevos usuarios y asigna rápidamente las empresas que podrán gestionar.</p>
              </div>
              <div class="dev-head-actions">
                <button id="d-refresh" class="secondary" style="padding:10px 18px;border-radius:10px;">🔄 Actualizar</button>
              </div>
            </div>
            <div id="d-list" class="dev-collection" style="margin-top:20px;"></div>
          </div>
        </article>

        <article class="card dev-section" id="adminsCard">
          <div class="dev-section-head">
            <div>
              <h3>Admins existentes</h3>
              <p>Consulta y ajusta la asignacion de empresas para cada administrador.</p>
            </div>
            <div class="dev-head-actions">
              <button id="a-refresh" class="secondary">Actualizar</button>
            </div>
          </div>
          <div id="a-list" class="dev-collection"></div>
        </article>
      </div>
    </section>
  </main>
  <script type="module">
  import { API } from './assets/js/api.esm.js';
  const LS_KEY='dev:token';
  function setHeroStat(id, value){
    const el = document.getElementById(id);
    if (el) el.textContent = String(value);
  }
  function setTok(t){ try{ localStorage.setItem(LS_KEY, t||''); }catch{} }
  function getTok(){ try{ return localStorage.getItem(LS_KEY)||''; }catch{return '';} }
  async function req(path, opts={}){
    const headers = { 'Content-Type':'application/json' };
    const tok = getTok(); 
    
    if(tok) headers.Authorization = 'Bearer '+tok;
    
    const fullUrl = (window.API_BASE||'')+path;
    console.log('Making request to:', fullUrl, 'with options:', opts);
    
    const res = await fetch(fullUrl, { ...opts, headers, body: opts.body?JSON.stringify(opts.body):undefined });
    const txt = await res.text(); 
    let data; 
    try{ 
      data=JSON.parse(txt);
    }catch{ 
      data=txt; 
    }
    
    console.log('Response status:', res.status, 'Response data:', data);
    
    if(!res.ok) {
      console.error('Request failed:', res.status, data);
      throw new Error(data?.error || res.statusText);
    }
    return data;
  }
  
  // PIN de desarrollador
  const DEV_PIN = '122923';
  
  document.getElementById('d-login').onclick = async ()=>{
    const pin = document.getElementById('d-pin').value.trim();
    
    if (pin !== DEV_PIN) {
      alert('PIN incorrecto. Acceso denegado.');
      document.getElementById('d-pin').value = '';
      document.getElementById('d-pin').focus();
      return;
    }
    
    // PIN correcto - obtener token de desarrollador del backend
    try {
      console.log('PIN correcto - obteniendo token de desarrollador');
      const fullUrl = (window.API_BASE||'') + '/api/v1/admin/auth/dev-login';
      console.log('Login URL:', fullUrl);
      
      const response = await fetch(fullUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pin })
      });
      
      console.log('Login response status:', response.status);
      
      if (response.ok) {
        const data = await response.json();
        setTok(data.token);
        console.log('Token de desarrollador obtenido:', data);
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('appSection').classList.remove('hidden');
        document.getElementById('requestsCard').style.display = '';
        document.getElementById('devTabs').style.display = 'flex';
        loadReqs();
        loadAdmins();
      } else {
        const error = await response.json();
        console.error('Login error:', error);
        alert('Error al autenticar: ' + (error.error || 'Error desconocido'));
      }
    } catch (error) {
      console.error('Error al obtener token:', error);
      alert('Error de conexión. Intenta de nuevo.');
    }
  };
  async function loadReqs(){
    const wrap = document.getElementById('d-list');
    wrap.innerHTML = '<div style="padding:24px;text-align:center;color:rgba(226,232,240,0.7);">Cargando solicitudes...</div>';
    try{
      const r = await req('/api/v1/admin/signup/requests');
      wrap.innerHTML = '';
      const companies = r.companies||[];
      const requests = r.items||[];
      setHeroStat('stat-requests', requests.length);
      
      if(!requests.length){
        wrap.innerHTML = '<div style="padding:32px;text-align:center;color:rgba(226,232,240,0.7);">✅ No hay solicitudes pendientes</div>';
        return;
      }
      
      requests.forEach(item=>{
        const div = document.createElement('div');
        div.className='card';
        div.style.cssText = 'margin-bottom:16px;padding:20px;border-radius:16px;background:rgba(15,23,42,0.6);border:1px solid rgba(148,163,184,0.25);';
        
        const statusColor = item.status === 'pending' ? '#f59e0b' : item.status === 'approved' ? '#10b981' : '#6b7280';
        const statusText = item.status === 'pending' ? 'Pendiente' : item.status === 'approved' ? 'Aprobada' : 'Completada';
        const isPending = item.status === 'pending';
        const assignedIds = (item.assignedCompanies || []).map(ac => String(ac?._id || ac));
        
        div.innerHTML = `
          <div style="display:flex;flex-direction:column;gap:16px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap;">
              <div style="flex:1;min-width:200px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                  <strong style="font-size:16px;color:#f8fafc;">${item.email}</strong>
                  <span style="padding:4px 10px;border-radius:8px;font-size:11px;font-weight:600;text-transform:uppercase;background:${statusColor}20;color:${statusColor};border:1px solid ${statusColor}40;">
                    ${statusText}
                  </span>
                </div>
                <div style="font-size:12px;color:rgba(226,232,240,0.6);">
                  ${item.createdAt ? `Solicitado: ${new Date(item.createdAt).toLocaleDateString('es-CO', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}` : ''}
                </div>
              </div>
              ${isPending ? `
                <div style="display:flex;gap:8px;">
                  <button class="approve-btn" style="padding:10px 20px;border-radius:10px;border:none;background:linear-gradient(135deg,#10b981,#059669);color:#fff;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,0.3);transition:transform 0.2s,box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">
                    ✅ Aprobar
                  </button>
                </div>
              ` : item.status === 'approved' ? `
                <div style="padding:8px 12px;border-radius:8px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:#10b981;font-size:12px;">
                  Esperando confirmación del usuario
                </div>
              ` : ''}
            </div>
            
            ${isPending ? `
              <div style="border-top:1px solid rgba(148,163,184,0.2);padding-top:16px;">
                <div style="margin-bottom:12px;">
                  <label style="display:block;font-size:13px;font-weight:600;color:rgba(226,232,240,0.9);margin-bottom:8px;">
                    📋 Asignar empresas (opcional)
                  </label>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;max-height:200px;overflow-y:auto;padding:12px;background:rgba(15,23,42,0.4);border-radius:10px;border:1px solid rgba(148,163,184,0.15);">
                    ${companies.length > 0 ? companies.map(c=>{
                      const isChecked = assignedIds.includes(String(c._id));
                      return `
                        <label style="display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;background:${isChecked ? 'rgba(59,130,246,0.2)' : 'rgba(15,23,42,0.6)'};border:1px solid ${isChecked ? 'rgba(59,130,246,0.4)' : 'rgba(148,163,184,0.2)'};cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='rgba(59,130,246,0.15)'" onmouseout="this.style.background='${isChecked ? 'rgba(59,130,246,0.2)' : 'rgba(15,23,42,0.6)'}'">
                          <input type="checkbox" data-c="${c._id}" ${isChecked ? 'checked' : ''} style="cursor:pointer;accent-color:#3b82f6;" />
                          <span style="font-size:13px;color:#f8fafc;">${c.name || c.email}</span>
                        </label>
                      `;
                    }).join('') : '<div style="color:rgba(226,232,240,0.6);font-size:12px;">No hay empresas disponibles</div>'}
                  </div>
                  <div style="margin-top:8px;font-size:11px;color:rgba(226,232,240,0.5);">
                    Selecciona las empresas que este admin podrá gestionar. Si no seleccionas ninguna, podrá gestionar todas.
                  </div>
                </div>
              </div>
            ` : item.assignedCompanies && item.assignedCompanies.length > 0 ? `
              <div style="border-top:1px solid rgba(148,163,184,0.2);padding-top:16px;">
                <div style="font-size:12px;color:rgba(226,232,240,0.7);margin-bottom:8px;">Empresas asignadas:</div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;">
                  ${item.assignedCompanies.map(ac => {
                    const company = companies.find(c => String(c._id) === String(ac?._id || ac));
                    return company ? `<span style="padding:4px 10px;border-radius:6px;background:rgba(59,130,246,0.15);color:#60a5fa;font-size:11px;">${company.name || company.email}</span>` : '';
                  }).filter(Boolean).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
        
        const approveBtn = div.querySelector('.approve-btn');
        if(approveBtn){
          approveBtn.onclick = async ()=>{
            if(!confirm(`¿Estás seguro de aprobar la solicitud de ${item.email}?`)) return;
            
            const selected = Array.from(div.querySelectorAll('input[type=checkbox][data-c]:checked')).map(x=>x.dataset.c);
            approveBtn.disabled = true;
            approveBtn.textContent = 'Procesando...';
            approveBtn.style.opacity = '0.6';
            approveBtn.style.cursor = 'not-allowed';
            
            try{
              const res = await req(`/api/v1/admin/signup/requests/${item._id}/approve`, { 
                method:'POST', 
                body:{ companies: selected } 
              });
              
              const codeMsg = `✅ Solicitud aprobada exitosamente!\n\n📧 Email: ${item.email}\n🔑 Código de activación: ${res.code}\n\n⚠️ IMPORTANTE: Comparte este código con el solicitante. Necesitará este código para completar su registro.`;
              
              // Mostrar modal más bonito
              const modal = document.createElement('div');
              modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(4px);';
              modal.innerHTML = `
                <div style="background:rgba(15,23,42,0.95);border:1px solid rgba(148,163,184,0.3);border-radius:20px;padding:32px;max-width:500px;width:90%;box-shadow:0 24px 60px rgba(0,0,0,0.5);">
                  <h3 style="margin:0 0 16px;color:#f8fafc;font-size:20px;">✅ Solicitud Aprobada</h3>
                  <div style="background:rgba(15,23,42,0.6);border-radius:12px;padding:16px;margin-bottom:20px;border:1px solid rgba(148,163,184,0.2);">
                    <div style="margin-bottom:12px;color:rgba(226,232,240,0.9);">
                      <strong style="color:#f8fafc;">Email:</strong> ${item.email}
                    </div>
                    <div style="margin-bottom:12px;">
                      <div style="font-size:12px;color:rgba(226,232,240,0.7);margin-bottom:6px;">Código de activación:</div>
                      <div style="background:rgba(16,185,129,0.15);border:2px solid rgba(16,185,129,0.4);border-radius:10px;padding:12px;font-family:monospace;font-size:24px;font-weight:700;color:#10b981;text-align:center;letter-spacing:4px;">
                        ${res.code}
                      </div>
                    </div>
                    <div style="padding:10px;background:rgba(245,158,11,0.1);border-left:3px solid #f59e0b;border-radius:6px;font-size:12px;color:#fbbf24;">
                      ⚠️ Comparte este código con el solicitante. Necesitará este código para completar su registro.
                    </div>
                  </div>
                  <button onclick="this.closest('div[style*=\\'position:fixed\\']').remove()" style="width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(135deg,#3b82f6,#6366f1);color:#fff;font-weight:600;cursor:pointer;">
                    Cerrar
                  </button>
                </div>
              `;
              document.body.appendChild(modal);
              modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
              
              loadReqs();
            }catch(e){ 
              approveBtn.disabled = false;
              approveBtn.textContent = '✅ Aprobar';
              approveBtn.style.opacity = '1';
              approveBtn.style.cursor = 'pointer';
              alert('❌ Error: ' + (e.message||'Error desconocido')); 
            }
          };
        }
        
        wrap.appendChild(div);
      });
    }catch(e){
      wrap.innerHTML = `<div style="padding:24px;text-align:center;color:#ef4444;">❌ Error: ${e.message||'Error desconocido'}</div>`;
      setHeroStat('stat-requests', 0);
    }
  }
  document.getElementById('d-refresh').onclick = loadReqs;

  // Admins existentes: listar y editar asignacion de empresas
  async function loadAdmins(){
    const wrap = document.getElementById('a-list');
    wrap.innerHTML = '<div class="muted">Cargando...</div>';
    try{
      const list = await (async()=>{
        try{ const r = await req('/api/v1/admin/admins'); return r.items||[]; }catch{ return []; }
      })();
      const companies = await (async()=>{
        try{ const c = await req('/api/v1/admin/companies'); return c.items||[]; }catch{ return []; }
      })();
      wrap.innerHTML = '';
      setHeroStat('stat-admins', list.length);
      if(!list.length){ wrap.innerHTML = '<div class="muted">Aun no hay admins creados o falta endpoint.</div>'; return; }
      list.forEach(u=>{
        const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
        div.innerHTML = `<div class='row between' style='align-items:center;'>
          <div>
            <div><strong>${u.email}</strong> <span class='muted' style='font-size:12px;'>(${u.role})</span></div>
          </div>
          <div style='flex:1;margin:0 12px;'>
            <div class='row wrap' style='gap:6px;'>
              ${companies.map(c=>`<label class='chip'><input type='checkbox' data-c='${c._id}' ${u.companies?.some?.(ac=>String(ac)===String(c._id))?'checked':''}/> ${c.name||c.email}</label>`).join('')}
            </div>
          </div>
          <div style='display:flex;gap:8px;'>
            <button class='save secondary'>Guardar</button>
            <button class='delete-admin' style='padding:8px 16px;border-radius:8px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.1);color:#ef4444;cursor:pointer;'>Eliminar</button>
          </div>
        </div>`;
        div.querySelector('.save').onclick = async ()=>{
          const selected = Array.from(div.querySelectorAll('input[type=checkbox][data-c]:checked')).map(x=>x.dataset.c);
          try{
            await req(`/api/v1/admin/admins/${u._id}/companies`, { method:'PATCH', body:{ companies: selected } });
            alert('Guardado');
            loadAdmins(); // Recargar lista
          }catch(e){ alert(e.message||'Error'); }
        };
        div.querySelector('.delete-admin').onclick = async ()=>{
          if(!confirm(`¿Estás seguro de eliminar el admin ${u.email}?\n\nEsto eliminará:\n- El acceso del admin\n- Cualquier compartimiento de BD configurado para sus empresas`)) return;
          try{
            await req(`/api/v1/admin/admins/${u._id}`, { method:'DELETE' });
            alert('Admin eliminado exitosamente');
            loadAdmins(); // Recargar lista
          }catch(e){ alert('Error: ' + (e.message||'Error desconocido')); }
        };
        wrap.appendChild(div);
      });
    }catch(e){ wrap.innerHTML = `<div class='muted'>${e.message||'Error'}</div>`; }
  }
  document.getElementById('a-refresh').onclick = loadAdmins;

  // Tabs behavior
  const devTabs = document.getElementById('devTabs');
  const requestsCard = document.getElementById('requestsCard');
  const requestsContent = document.getElementById('requestsContent');
  const adminsCard = document.getElementById('adminsCard');
  const toggleSections = (t)=>{
    if(requestsContent) requestsContent.style.display = (t==='reqs') ? '' : 'none';
    if(adminsCard) adminsCard.style.display = (t==='admins') ? '' : 'none';
    if(requestsCard) requestsCard.classList.toggle('active', t==='reqs');
  };
  devTabs?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-t]'); if(!btn) return;
    devTabs.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.t;
    toggleSections(t);
    if(t==='admins') loadAdmins();
    if(t==='reqs') loadReqs();
  });
  const activeTab = devTabs?.querySelector('button.active')?.dataset.t;
  if(activeTab) toggleSections(activeTab);
  
  // Botón de cerrar sesión
  document.getElementById('dev-logout').onclick = () => {
    setTok('');
    document.getElementById('loginSection').classList.remove('hidden');
    document.getElementById('appSection').classList.add('hidden');
    document.getElementById('d-pin').value = '';
  };
  
  // Enter en el campo PIN
  document.getElementById('d-pin').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('d-login').click();
    }
  });
  
  // REMOVIDO: Todas las funciones relacionadas con empresas y toggles han sido movidas al panel de admin
  </script>
</body>
</html>
