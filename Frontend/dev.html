<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Developer</title>
  <link rel="stylesheet" href="assets/styles.css?v=20251010" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <script src="./assets/js/config.js"></script>
  <script src="./assets/js/api.js"></script>
  <style>
    body[data-page="developer"]{
      background:
        radial-gradient(circle at 15% -10%, rgba(79,70,229,0.18), transparent 55%),
        linear-gradient(160deg, rgba(8,145,178,0.18), transparent 60%);
      min-height:100vh;
      margin:0;
      color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    }
    body[data-page="developer"] main{
      padding:32px 16px 64px;
    }
    body[data-page="developer"] .card{
      background:rgba(15,23,42,0.7);
      border:1px solid rgba(148,163,184,0.28);
      color:inherit;
    }
    .dev-main{
      max-width:1100px;
      margin:0 auto;
    }
    .dev-login{
      display:flex;
      justify-content:center;
    }
    .dev-login-card{
      max-width:420px;
      margin:36px auto;
      padding:32px 36px;
      border-radius:20px;
      box-shadow:0 16px 40px rgba(15,23,42,0.28);
    }
    .dev-login-card h2{
      margin-top:0;
      margin-bottom:16px;
      text-align:center;
    }
    .dev-login-card label{
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted, rgba(226,232,240,0.65));
    }
    .dev-login-card input{
      width:100%;
      margin:6px 0 14px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.25);
      background:rgba(15,23,42,0.45);
      color:inherit;
      padding:10px 14px;
      transition:border .2s, box-shadow .2s;
    }
    .dev-login-card input:focus{
      outline:none;
      border-color:var(--accent,#38bdf8);
      box-shadow:0 0 0 2px rgba(56,189,248,0.25);
    }
    body[data-page="developer"] button{
      background:#38bdf8;
      color:#0f172a;
      border:none;
    }
    body[data-page="developer"] button.secondary{
      background:transparent;
      color:inherit;
      border:1px solid rgba(148,163,184,0.28);
    }
    .dev-app{
      animation:fadeIn .45s ease .08s both;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform:translateY(12px); }
      to{ opacity:1; transform:translateY(0); }
    }
    .dev-shell{
      display:grid;
      gap:24px;
    }
    .dev-hero{
      display:flex;
      flex-wrap:wrap;
      gap:24px;
      align-items:flex-start;
      padding:28px 32px;
      border-radius:24px;
      border:1px solid rgba(148,163,184,0.22);
      background:linear-gradient(135deg, rgba(15,23,42,0.85), rgba(30,41,59,0.7));
      box-shadow:0 24px 60px rgba(8,15,35,0.45);
      backdrop-filter:blur(18px);
    }
    .dev-hero h1{
      margin:0 0 8px;
      font-size:2rem;
      letter-spacing:-0.02em;
    }
    .dev-hero p{
      margin:0;
      max-width:520px;
      color:var(--muted, rgba(226,232,240,0.65));
      font-size:0.95rem;
    }
    .dev-hero-text{
      flex:1 1 320px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .dev-stat-grid{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:stretch;
    }
    .dev-stat{
      min-width:150px;
      padding:14px 18px;
      border-radius:16px;
      background:rgba(15,23,42,0.45);
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:0 12px 32px rgba(8,15,35,0.35);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .dev-stat span{
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted, rgba(226,232,240,0.6));
    }
    .dev-stat strong{
      font-size:28px;
      line-height:1;
      color:var(--accent,#38bdf8);
      font-weight:700;
    }
    .dev-section{
      padding:24px 28px;
      border-radius:20px;
      box-shadow:0 18px 44px rgba(8,15,35,0.35);
      border:1px solid rgba(148,163,184,0.18);
      background:rgba(15,23,42,0.55);
      backdrop-filter:blur(12px);
    }
    .dev-company-card.dev-card-flash{
      box-shadow:0 0 0 2px rgba(56,189,248,0.6),0 18px 44px rgba(8,15,35,0.35);
      transition:box-shadow .3s ease;
    }
    .dev-section-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      flex-wrap:wrap;
    }
    .dev-section-head h3{
      margin:0;
      font-size:1.35rem;
    }
    .dev-section-head p{
      margin:4px 0 0;
      max-width:520px;
      color:var(--muted, rgba(226,232,240,0.65));
      font-size:0.95rem;
    }
    .dev-head-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    #devTabs{
      display:flex;
      gap:10px;
      margin-bottom:18px;
      background:rgba(15,23,42,0.35);
      border-radius:16px;
      padding:6px;
      border:1px solid rgba(148,163,184,0.18);
    }
    #devTabs button{
      flex:1;
      min-width:160px;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:600;
      color:inherit;
      background:transparent;
      transition:background .2s, box-shadow .2s, transform .2s;
    }
    #devTabs button:hover{
      background:rgba(59,130,246,0.15);
    }
    #devTabs button.active{
      background:linear-gradient(135deg, rgba(79,70,229,0.32), rgba(59,130,246,0.25));
      box-shadow:0 12px 26px rgba(59,130,246,0.35);
      transform:translateY(-1px);
    }
    .dev-toolbar{
      margin-top:16px;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }
    .dev-search{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .dev-search input[type="search"]{
      min-width:240px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.28);
      background:rgba(15,23,42,0.45);
      color:inherit;
      transition:border .2s, box-shadow .2s;
    }
    .dev-search input[type="search"]::placeholder{
      color:var(--muted, rgba(226,232,240,0.55));
      letter-spacing:.01em;
    }
    .dev-search input[type="search"]:focus{
      outline:none;
      border-color:var(--accent,#38bdf8);
      box-shadow:0 0 0 2px rgba(56,189,248,0.25);
    }
    .dev-toolbar-meta{
      display:flex;
      gap:10px;
      align-items:center;
      font-size:13px;
      color:var(--muted, rgba(226,232,240,0.6));
    }
    .dev-toolbar-meta .bullet{
      width:6px;
      height:6px;
      border-radius:50%;
      background:rgba(148,163,184,0.45);
      display:inline-block;
    }
    .dev-grid{
      display:grid;
      gap:16px;
      margin-top:18px;
    }
    .dev-company-card{
      padding:22px 24px;
      border-radius:20px;
    }
    .dev-chip-grid{
      display:grid;
      gap:12px;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    }
    .dev-chip-grid .toggle{
      width:100%;
    }
    
    /* Estilos específicos para toggles en el panel de desarrollo */
    .dev-company-card .toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      margin-bottom: 8px;
    }
    
    .dev-company-card .toggle:hover {
      background: var(--highlight-bg);
      border-color: var(--accent);
    }
    
    .dev-company-card .toggle-text {
      font-weight: 500;
      color: var(--text);
      margin-right: 12px;
    }
    
    .dev-company-card .toggle input[type="checkbox"] {
      display: none;
    }
    
    .dev-company-card .toggle-slider {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--border);
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    
    .dev-company-card .toggle-slider::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .dev-company-card .toggle input[type="checkbox"]:checked + .toggle-slider {
      background: var(--accent);
    }
    
    .dev-company-card .toggle input[type="checkbox"]:checked + .toggle-slider::before {
      transform: translateX(20px);
    }
    
    .dev-company-card .toggle input[type="checkbox"]:focus + .toggle-slider {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Estilos para las opciones específicas */
    .dev-options-grid .card {
      margin-bottom: 16px;
      padding: 16px;
      background: var(--card-alt);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    
    .dev-options-grid .card > div:first-child {
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text);
    }
    
    .dev-actions-row {
      margin-top: 12px;
      text-align: right;
    }
    
    .dev-actions-row button {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    
    .dev-actions-row button:hover {
      background: var(--accent-hover);
    }
    
    /* Estilos para forzar actualización visual de toggles */
    .dev-company-card .toggle input[type="checkbox"]:checked + .toggle-slider {
      background: var(--accent) !important;
      box-shadow: 0 0 0 2px rgba(16,185,129,.35) !important;
    }
    
    .dev-company-card .toggle input[type="checkbox"]:checked + .toggle-slider::before {
      transform: translateX(20px) !important;
      background: #ecfdf5 !important;
      box-shadow: 0 2px 8px rgba(16,185,129,.35) !important;
    }
    
    .dev-company-card .toggle input[type="checkbox"]:not(:checked) + .toggle-slider {
      background: rgba(100,116,139,.45) !important;
      box-shadow: inset 0 0 0 1px rgba(15,23,42,.35) !important;
    }
    
    .dev-company-card .toggle input[type="checkbox"]:not(:checked) + .toggle-slider::before {
      transform: translateX(0px) !important;
      background: white !important;
      box-shadow: 0 2px 6px rgba(15,23,42,.35) !important;
    }
  </style>
</head>
<body data-page="developer">
  <noscript>
    <div style="background:#1f2937;color:#f8fafc;padding:16px;text-align:center;">
      Activa JavaScript para usar el panel developer.
    </div>
  </noscript>
    <main class="dev-main" style="max-width:1100px;margin:0 auto;padding:32px 16px 64px;">
    <section id="loginSection" class="dev-login" style="display:flex;justify-content:center;align-items:flex-start;">
      <div class="card dev-login-card" style="max-width:440px;width:100%;margin:48px auto;padding:40px;border-radius:24px;box-shadow:0 18px 48px rgba(15,23,42,0.45);background:#0f172a;border:1px solid rgba(148,163,184,0.55);color:#f8fafc;">
        <h1 style="margin:0 0 12px;text-align:center;font-size:28px;">Panel Developer</h1>
        <p style="margin:0 0 24px;text-align:center;color:rgba(226,232,240,0.7);font-size:14px;">Accede con el PIN de desarrollador para administrar la configuración.</p>
        <label style="display:block;font-size:13px;text-transform:uppercase;letter-spacing:.08em;color:rgba(226,232,240,0.78);margin-bottom:6px;">PIN de Desarrollador</label>
        <input id="d-pin" type="password" maxlength="6" placeholder="Ingresa el PIN" style="width:100%;margin:0 0 24px;border-radius:14px;border:1px solid rgba(148,163,184,0.5);background:#1e293b;color:#f8fafc;padding:12px 16px;font-size:15px;text-align:center;letter-spacing:2px;" />
        <button id="d-login" style="width:100%;padding:12px 16px;border-radius:14px;border:none;background:linear-gradient(135deg,#38bdf8,#6366f1);color:#0f172a;font-weight:700;cursor:pointer;box-shadow:0 20px 42px rgba(56,189,248,0.4);">Entrar</button>
        <p style="margin:20px 0 0;text-align:center;font-size:12px;color:rgba(226,232,240,0.6);">Solo el desarrollador tiene acceso a este panel.</p>
      </div>
    </section>
    <section id="appSection" class="hidden dev-app">
      <div class="dev-shell">
        <article class="card dev-hero">
          <div class="dev-hero-text">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h1>Panel de Desarrollo</h1>
            <p>Configura módulos y opciones específicas para tu empresa desde un mismo lugar.</p>
          </div>
          <div style="display:flex;gap:8px;">
            <button id="dev-apply" style="padding:8px 16px;border-radius:8px;border:1px solid rgba(148,163,184,0.3);background:rgba(34,197,94,0.1);color:#22c55e;cursor:pointer;">Aplicar Cambios</button>
            <button id="dev-logout" style="padding:8px 16px;border-radius:8px;border:1px solid rgba(148,163,184,0.3);background:rgba(239,68,68,0.1);color:#ef4444;cursor:pointer;">Cerrar Sesión</button>
          </div>
        </div>
          </div>
          <div class="dev-stat-grid">
            <div class="dev-stat">
              <span>Solicitudes</span>
              <strong id="stat-requests">0</strong>
            </div>
            <div class="dev-stat">
              <span>Empresas</span>
              <strong id="stat-companies">0</strong>
            </div>
            <div class="dev-stat">
              <span>Activas</span>
              <strong id="stat-companies-active">0</strong>
            </div>
            <div class="dev-stat">
              <span>Admins</span>
              <strong id="stat-admins">0</strong>
            </div>
          </div>
        </article>

        <article class="card dev-section" id="requestsCard" style="display:none;">
          <nav class="tabs" id="devTabs" style="display:none;">
            <button data-t="reqs" class="active">Solicitudes</button>
            <button data-t="companies">Empresas y Funciones</button>
            <button data-t="admins">Admins</button>
          </nav>
          <div id="requestsContent">
            <div class="dev-section-head">
              <div>
                <h3>Solicitudes de Admin</h3>
                <p>Aprueba nuevos usuarios y asigna rapidamente las empresas que podran gestionar.</p>
              </div>
              <div class="dev-head-actions">
                <button id="d-refresh" class="secondary">Actualizar</button>
              </div>
            </div>
            <div id="d-list" class="dev-collection"></div>
          </div>
        </article>

        <article class="card dev-section" id="companiesCard">
          <div class="dev-section-head">
            <div>
              <h3>Empresas y funciones</h3>
              <p>Activa modulos, subfunciones y restricciones especificas para cada empresa.</p>
            </div>
            <div class="dev-head-actions">
              <button id="c-refresh" class="secondary">Actualizar</button>
            </div>
          </div>
          <div class="dev-toolbar">
            <div class="dev-search">
              <input type="search" id="c-filter" placeholder="Buscar por nombre, correo o NIT..." autocomplete="off" />
              <button class="secondary" type="button" id="c-clear">Limpiar</button>
            </div>
            <div class="dev-toolbar-meta" id="c-stats">0 empresas</div>
          </div>
          <div id="c-list" class="dev-grid"></div>
        </article>

        <article class="card dev-section" id="adminsCard">
          <div class="dev-section-head">
            <div>
              <h3>Admins existentes</h3>
              <p>Consulta y ajusta la asignacion de empresas para cada administrador.</p>
            </div>
            <div class="dev-head-actions">
              <button id="a-refresh" class="secondary">Actualizar</button>
            </div>
          </div>
          <div id="a-list" class="dev-collection"></div>
        </article>
      </div>
    </section>
  </main>
  <script type="module">
  import { API } from './assets/js/api.esm.js';
  const LS_KEY='dev:token';
  let companiesData = [];
  function setHeroStat(id, value){
    const el = document.getElementById(id);
    if (el) el.textContent = String(value);
  }
  function setTok(t){ try{ localStorage.setItem(LS_KEY, t||''); }catch{} }
  function getTok(){ try{ return localStorage.getItem(LS_KEY)||''; }catch{return '';} }
  async function req(path, opts={}){
    const headers = { 'Content-Type':'application/json' };
    const tok = getTok(); 
    
    if(tok) headers.Authorization = 'Bearer '+tok;
    
    const fullUrl = (window.API_BASE||'')+path;
    console.log('Making request to:', fullUrl, 'with options:', opts);
    
    const res = await fetch(fullUrl, { ...opts, headers, body: opts.body?JSON.stringify(opts.body):undefined });
    const txt = await res.text(); 
    let data; 
    try{ 
      data=JSON.parse(txt);
    }catch{ 
      data=txt; 
    }
    
    console.log('Response status:', res.status, 'Response data:', data);
    
    if(!res.ok) {
      console.error('Request failed:', res.status, data);
      throw new Error(data?.error || res.statusText);
    }
    return data;
  }
  
  // PIN de desarrollador
  const DEV_PIN = '122923';
  
  document.getElementById('d-login').onclick = async ()=>{
    const pin = document.getElementById('d-pin').value.trim();
    
    if (pin !== DEV_PIN) {
      alert('PIN incorrecto. Acceso denegado.');
      document.getElementById('d-pin').value = '';
      document.getElementById('d-pin').focus();
      return;
    }
    
    // PIN correcto - obtener token de desarrollador del backend
    try {
      console.log('PIN correcto - obteniendo token de desarrollador');
      const fullUrl = (window.API_BASE||'') + '/api/v1/admin/auth/dev-login';
      console.log('Login URL:', fullUrl);
      
      const response = await fetch(fullUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pin })
      });
      
      console.log('Login response status:', response.status);
      
      if (response.ok) {
        const data = await response.json();
        setTok(data.token);
        console.log('Token de desarrollador obtenido:', data);
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('appSection').classList.remove('hidden');
        loadCompanies();
      } else {
        const error = await response.json();
        console.error('Login error:', error);
        alert('Error al autenticar: ' + (error.error || 'Error desconocido'));
      }
    } catch (error) {
      console.error('Error al obtener token:', error);
      alert('Error de conexión. Intenta de nuevo.');
    }
  };
  async function loadReqs(){
    const wrap = document.getElementById('d-list');
    wrap.innerHTML = '<div class="muted">Cargando...</div>';
    try{
      const r = await req('/api/v1/admin/signup/requests');
      wrap.innerHTML = '';
      const companies = r.companies||[];
      const requests = r.items||[];
      setHeroStat('stat-requests', requests.length);
      requests.forEach(item=>{
        const div = document.createElement('div');
        div.className='card'; div.style.marginBottom='8px';
        div.innerHTML = `<div class='row between' style='align-items:center;'>
          <div>
            <div><strong>${item.email}</strong></div>
            <div class='muted' style='font-size:12px;'>Estado: ${item.status}</div>
          </div>
          <div>
            <details>
              <summary>Asignar empresas</summary>
              <div class='row wrap' style='gap:6px;margin-top:6px;'>
                ${companies.map(c=>`<label class='chip'><input type='checkbox' data-c='${c._id}' ${item.assignedCompanies?.some?.(ac=>String(ac?._id||ac)===String(c._id))?'checked':''}/> ${c.name||c.email}</label>`).join('')}
              </div>
            </details>
            <div class='row right' style='gap:6px;margin-top:6px;'>
              <button class='approve'>Aprobar</button>
            </div>
          </div>
        </div>`;
        div.querySelector('.approve').onclick = async ()=>{
          const selected = Array.from(div.querySelectorAll('input[type=checkbox][data-c]:checked')).map(x=>x.dataset.c);
          try{
            const res = await req(`/api/v1/admin/signup/requests/${item._id}/approve`, { method:'POST', body:{ companies: selected } });
            alert(`Codigo generado: ${res.code}\nCompartelo con el solicitante.`);
            loadReqs();
          }catch(e){ alert(e.message||'Error'); }
        };
        wrap.appendChild(div);
      });
      if(!wrap.children.length){ wrap.innerHTML = '<div class="muted">Sin solicitudes pendientes</div>'; }
    }catch(e){
      wrap.innerHTML = `<div class='muted'>${e.message||'Error'}</div>`;
      setHeroStat('stat-requests', 0);
    }
  }
  document.getElementById('d-refresh').onclick = loadReqs;

  // Admins existentes: listar y editar asignacion de empresas
  async function loadAdmins(){
    const wrap = document.getElementById('a-list');
    wrap.innerHTML = '<div class="muted">Cargando...</div>';
    try{
      // Usamos /companies para catalogo, y buscamos admins via /api/v1/admin/auth/me? (no hay listado). Implementamos llamado directo a un endpoint opcional: de momento, pedimos los admins por email manualmente.
      // Para no ampliar backend mas, haremos una llamada simple al servidor que no existe; como si ampliamos antes, mejor listemos AdminUsers developers y admins: anadimos endpoint rapido.
      const list = await (async()=>{
        try{ const r = await req('/api/v1/admin/admins'); return r.items||[]; }catch{ return []; }
      })();
      const companies = await (async()=>{
        try{ const c = await req('/api/v1/admin/companies'); return c.items||[]; }catch{ return []; }
      })();
      wrap.innerHTML = '';
      setHeroStat('stat-admins', list.length);
      if(!list.length){ wrap.innerHTML = '<div class="muted">Aun no hay admins creados o falta endpoint.</div>'; return; }
      list.forEach(u=>{
        const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
        div.innerHTML = `<div class='row between' style='align-items:center;'>
          <div>
            <div><strong>${u.email}</strong> <span class='muted' style='font-size:12px;'>(${u.role})</span></div>
          </div>
          <div style='flex:1;margin:0 12px;'>
            <div class='row wrap' style='gap:6px;'>
              ${companies.map(c=>`<label class='chip'><input type='checkbox' data-c='${c._id}' ${u.companies?.some?.(ac=>String(ac)===String(c._id))?'checked':''}/> ${c.name||c.email}</label>`).join('')}
            </div>
          </div>
          <div>
            <button class='save secondary'>Guardar</button>
          </div>
        </div>`;
        div.querySelector('.save').onclick = async ()=>{
          const selected = Array.from(div.querySelectorAll('input[type=checkbox][data-c]:checked')).map(x=>x.dataset.c);
          try{
            await req(`/api/v1/admin/admins/${u._id}/companies`, { method:'PATCH', body:{ companies: selected } });
            alert('Guardado');
          }catch(e){ alert(e.message||'Error'); }
        };
        wrap.appendChild(div);
      });
    }catch(e){ wrap.innerHTML = `<div class='muted'>${e.message||'Error'}</div>`; }
  }
  document.getElementById('a-refresh').onclick = loadAdmins;

  // ===== Empresas y Funciones =====
  
  // Función para actualizar los toggles visualmente después de guardar
  function updateTogglesFromData(div, company) {
    const id = String(company._id || company.id || '');
    const feat = company.features || {};
    const fopts = company.featureOptions || {};
    
    console.log('updateTogglesFromData called for company:', id, 'features:', feat, 'featureOptions:', fopts);
    
    // Actualizar toggles de módulos principales
    const featureList = [
      { key:'notas', label:'Notas' },
      { key:'ventas', label:'Ventas' },
      { key:'cotizaciones', label:'Cotizaciones' },
      { key:'inventario', label:'Inventario' },
      { key:'precios', label:'Lista de precios' },
      { key:'cashflow', label:'Flujo de caja' },
      { key:'techreport', label:'Reporte tecnico' },
      { key:'tecnicos', label:'Tecnicos' },
      { key:'templates', label:'Formatos / Plantillas' },
      { key:'skus', label:'SKUs' }
    ];
    
    // Default features if not set (all enabled by default)
    const defaultFeatures = {
      notas: true, ventas: true, cotizaciones: true, inventario: true, precios: true,
      cashflow: true, techreport: true, tecnicos: true, templates: true, skus: true
    };
    
    // Merge with defaults
    const mergedFeatures = { ...defaultFeatures, ...feat };
    console.log('Merged features:', mergedFeatures);
    
    featureList.forEach(({ key }) => {
      const input = div.querySelector(`#f-${id}-${key}`);
      if (input) {
        const newValue = mergedFeatures[key] !== false;
        console.log(`Updating toggle ${key}: ${input.checked} -> ${newValue}`);
        
        // Cambiar el valor del input
        input.checked = newValue;
        
        // Forzar actualización visual del toggle con un pequeño delay
        setTimeout(() => {
          // Disparar eventos para activar listeners
          input.dispatchEvent(new Event('change', { bubbles: true }));
          input.dispatchEvent(new Event('click', { bubbles: true }));
          
          // Forzar actualización visual del slider manualmente
          const slider = input.nextElementSibling;
          if (slider && slider.classList.contains('toggle-slider')) {
            if (newValue) {
              slider.style.background = 'var(--accent)';
              slider.style.boxShadow = '0 0 0 2px rgba(16,185,129,.35)';
            } else {
              slider.style.background = 'rgba(100,116,139,.45)';
              slider.style.boxShadow = 'inset 0 0 0 1px rgba(15,23,42,.35)';
            }
          }
        }, 10);
      } else {
        console.warn(`Toggle input not found: #f-${id}-${key}`);
      }
    });
    
    // Actualizar toggles de opciones específicas
    const blocks = {
      ventas: { importarCotizacion:'Importar cotizacion', ordenesTrabajo:'Ordenes de trabajo' },
      inventario: { ingresoVehiculo:'Ingreso de vehiculo', ingresoCompra:'Ingreso de compra', marketplace:'Marketplace', publicar:'Publicacion masiva', publicarAgotados:'Despublicar agotados', publicCatalogFields:'Campos de catalogo' },
      templates: { stickerQR:'Sticker: solo QR', stickerMarca:'Sticker: marca', stickerQRyMarca:'Sticker: QR + marca' }
    };
    
    Object.entries(blocks).forEach(([mod, opts]) => {
      Object.keys(opts).forEach(key => {
        const input = div.querySelector(`#fo-${id}-${mod}-${key}`);
        if (input) {
          const newValue = (fopts?.[mod]?.[key] !== false);
          console.log(`Updating feature option ${mod}.${key}: ${input.checked} -> ${newValue}`);
          
          // Cambiar el valor del input
          input.checked = newValue;
          
          // Forzar actualización visual del toggle con un pequeño delay
          setTimeout(() => {
            // Disparar eventos para activar listeners
            input.dispatchEvent(new Event('change', { bubbles: true }));
            input.dispatchEvent(new Event('click', { bubbles: true }));
            
            // Forzar actualización visual del slider manualmente
            const slider = input.nextElementSibling;
            if (slider && slider.classList.contains('toggle-slider')) {
              if (newValue) {
                slider.style.background = 'var(--accent)';
                slider.style.boxShadow = '0 0 0 2px rgba(16,185,129,.35)';
              } else {
                slider.style.background = 'rgba(100,116,139,.45)';
                slider.style.boxShadow = 'inset 0 0 0 1px rgba(15,23,42,.35)';
              }
            }
          }, 10);
        } else {
          console.warn(`Feature option input not found: #fo-${id}-${mod}-${key}`);
        }
      });
    });
    
    // Actualizar el badge de módulos
    const modulesBadge = div.querySelector('[data-modules-count]');
    if (modulesBadge) {
      const count = featureList.reduce((acc, item) => {
        const input = div.querySelector(`#f-${id}-${item.key}`);
        return acc + (input && input.checked ? 1 : 0);
      }, 0);
      modulesBadge.textContent = `Modulos ${count}`;
      console.log('Updated modules badge:', count);
    }
    
    // Forzar re-renderizado visual de todos los toggles
    setTimeout(() => {
      forceToggleVisualUpdate(div, id);
    }, 50);
    
    console.log('updateTogglesFromData completed');
  }
  
  // Función para forzar la actualización visual de los toggles
  function forceToggleVisualUpdate(div, id) {
    console.log('Forcing visual update for toggles...');
    
    // Obtener todos los inputs de toggles
    const allInputs = div.querySelectorAll('input[type="checkbox"]');
    console.log('Found toggle inputs:', allInputs.length);
    
    allInputs.forEach((input, index) => {
      const isChecked = input.checked;
      console.log(`Toggle ${index}: ${input.id} = ${isChecked}`);
      
      // Forzar actualización del estado visual
      input.style.display = 'none';
      input.offsetHeight; // Trigger reflow
      input.style.display = '';
      
      // Disparar eventos para actualizar el slider visual
      input.dispatchEvent(new Event('change', { bubbles: true }));
      input.dispatchEvent(new Event('input', { bubbles: true }));
      
      // Actualizar el slider manualmente usando CSS
      const slider = input.nextElementSibling;
      if (slider && slider.classList.contains('toggle-slider')) {
        console.log(`Updating slider for ${input.id}: checked=${isChecked}`);
        
        if (isChecked) {
          slider.style.setProperty('background', 'var(--accent)', 'important');
          slider.style.setProperty('box-shadow', '0 0 0 2px rgba(16,185,129,.35)', 'important');
        } else {
          slider.style.setProperty('background', 'rgba(100,116,139,.45)', 'important');
          slider.style.setProperty('box-shadow', 'inset 0 0 0 1px rgba(15,23,42,.35)', 'important');
        }
        
        // Actualizar el knob (::before pseudo-element)
        const knob = slider;
        if (knob) {
          if (isChecked) {
            knob.style.setProperty('--knob-transform', 'translateX(20px)');
            // Forzar actualización del pseudo-element
            const beforeStyle = window.getComputedStyle(knob, '::before');
            console.log('Knob before style:', beforeStyle.transform);
          } else {
            knob.style.setProperty('--knob-transform', 'translateX(0px)');
          }
        }
      }
    });
    
    console.log('Visual update completed');
  }
  
  function buildCompanyCard(company){
    const id = String(company._id || company.id || '');
    const featureList = [
      { key:'notas', label:'Notas' },
      { key:'ventas', label:'Ventas' },
      { key:'cotizaciones', label:'Cotizaciones' },
      { key:'inventario', label:'Inventario' },
      { key:'precios', label:'Lista de precios' },
      { key:'cashflow', label:'Flujo de caja' },
      { key:'techreport', label:'Reporte tecnico' },
      { key:'tecnicos', label:'Tecnicos' },
      { key:'templates', label:'Formatos / Plantillas' },
      { key:'skus', label:'SKUs' }
    ];
    const feat = company.features || {};
    const fopts = company.featureOptions || {};
    const restr = company.restrictions || {};
    
    // Default features if not set (all enabled by default)
    const defaultFeatures = {
      notas: true,
      ventas: true,
      cotizaciones: true,
      inventario: true,
      precios: true,
      cashflow: true,
      techreport: true,
      tecnicos: true,
      templates: true,
      skus: true
    };
    
    // Merge with defaults
    const mergedFeatures = { ...defaultFeatures, ...feat };
    
    const modulesCount = featureList.reduce((acc,item)=> acc + (mergedFeatures[item.key] !== false ? 1 : 0), 0);
    const div = document.createElement("div");
    div.className = "card dev-company-card";
    div.dataset.companyId = id;
    div.innerHTML = `
      <div class="dev-company-head">
        <div>
          <h4 class="dev-company-name">${company.name || company.email || 'Empresa'}</h4>
          <div class="dev-company-meta">
            <span>${company.email || 'Sin correo'}</span>
            ${company.documentNumber ? `<span>NIT ${company.documentNumber}</span>` : ''}
            ${company.city ? `<span>${company.city}</span>` : ''}
          </div>
        </div>
        <div class="dev-company-badges">
          <span class="badge ${company.active ? 'badge-success' : 'badge-danger'}">${company.active ? 'Activa' : 'Inactiva'}</span>
          <span class="badge" data-modules-count>Módulos ${modulesCount}</span>
        </div>
      </div>
      <div class="dev-company-body">
        <details open>
          <summary>Módulos</summary>
          <div class="dev-chip-grid" id="feat-${id}"></div>
          <div class="dev-actions-row"><button class="secondary" data-save-feat>Guardar modulos</button></div>
        </details>
        <details>
          <summary>Opciones</summary>
          <div class="dev-options-grid" id="fopts-${id}"></div>
          <div class="dev-actions-row"><button class="secondary" data-save-fopts>Guardar opciones</button></div>
        </details>
        <details>
          <summary>Restricciones</summary>
          <div class="dev-chip-grid" id="restr-${id}"></div>
          <div class="dev-actions-row"><button class="secondary" data-save-restr>Guardar restricciones</button></div>
        </details>
      </div>
    `;
    const wrapFeat = div.querySelector(`#feat-${id}`);
    featureList.forEach(({ key, label })=>{
      const cid = `f-${id}-${key}`;
      const enabled = mergedFeatures[key] !== false;
      wrapFeat.insertAdjacentHTML('beforeend', `
        <label class="toggle" data-feature-toggle="${key}">
          <span class="toggle-text">${label}</span>
          <input type="checkbox" id="${cid}" ${enabled ? 'checked' : ''}/>
          <span class="toggle-slider" aria-hidden="true"></span>
        </label>`);
    });
    const modulesBadge = div.querySelector('[data-modules-count]');
    const refreshModulesBadge = () => {
      if (!modulesBadge) return;
      const count = featureList.reduce((acc, item) => {
        const input = div.querySelector(`#f-${id}-${item.key}`);
        return acc + (input && input.checked ? 1 : 0);
      }, 0);
      modulesBadge.textContent = `Modulos ${count}`;
    };
    // Event listener para actualizar el badge de módulos
    wrapFeat.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox') {
        console.log('Feature toggle changed:', e.target.id, 'checked:', e.target.checked);
        refreshModulesBadge();
      }
    });
    refreshModulesBadge();

    const blocks = {
      ventas: { importarCotizacion:'Importar cotizacion', ordenesTrabajo:'Ordenes de trabajo' },
      inventario: { ingresoVehiculo:'Ingreso de vehiculo', ingresoCompra:'Ingreso de compra', marketplace:'Marketplace', publicar:'Publicacion masiva', publicarAgotados:'Despublicar agotados', publicCatalogFields:'Campos de catalogo' },
      templates: { stickerQR:'Sticker: solo QR', stickerMarca:'Sticker: marca', stickerQRyMarca:'Sticker: QR + marca' }
    };

    const buildOptionToggle = (mod, key, label) => {
      const cid = `fo-${id}-${mod}-${key}`;
      const enabled = (fopts?.[mod]?.[key] !== false);
      return `
        <label class="toggle">
          <span class="toggle-text">${label}</span>
          <input type="checkbox" id="${cid}" ${enabled ? 'checked' : ''}/>
          <span class="toggle-slider" aria-hidden="true"></span>
        </label>`;
    };

    const fowrap = div.querySelector(`#fopts-${id}`);
    Object.entries(blocks).forEach(([mod, opts]) => {
      const box = document.createElement('div');
      box.className = 'card';
      box.innerHTML = `<div><b>${mod}</b></div><div class='dev-chip-grid'></div>`;
      const row = box.querySelector('.dev-chip-grid');
      Object.entries(opts).forEach(([key, label]) => {
        row.insertAdjacentHTML('beforeend', buildOptionToggle(mod, key, label));
      });
      fowrap.appendChild(box);
    });
    
    // Agregar event listeners a los toggles de opciones específicas
    if (fowrap) {
      fowrap.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox') {
          console.log('Feature option toggle changed:', e.target.id, 'checked:', e.target.checked);
        }
      });
    }

    const restrWrap = div.querySelector(`#restr-${id}`);
    // Restricciones removidas - sección vacía por ahora
    restrWrap.insertAdjacentHTML('beforeend', `<div class='muted'>Sin restricciones configuradas</div>`);

    const readFeaturePayload = () => {
      const payload = {};
      featureList.forEach(({ key }) => {
        const input = div.querySelector(`#f-${id}-${key}`);
        payload[key] = !!input?.checked;
      });
      return payload;
    };

    const readFeatureOptionsPayload = () => {
      const payload = { ventas:{}, inventario:{}, templates:{} };
      Object.entries(blocks).forEach(([mod, opts]) => {
        Object.keys(opts).forEach(key => {
          const input = div.querySelector(`#fo-${id}-${mod}-${key}`);
          const isChecked = input?.checked || false;
          console.log(`Reading feature option ${mod}.${key}: input.checked = ${input?.checked}, final value = ${isChecked}`);
          payload[mod][key] = isChecked;
        });
      });
      console.log('Feature options payload:', payload);
      return payload;
    };

    const saveFeatBtn = div.querySelector('[data-save-feat]');
    console.log('Save features button found:', saveFeatBtn);
    
    if (saveFeatBtn) {
      saveFeatBtn.onclick = async () => {
        try {
          const payload = readFeaturePayload();
          console.log('Saving features for company:', id, 'payload:', payload);
          console.log('API_BASE:', window.API_BASE);
          console.log('Full URL:', (window.API_BASE||'') + `/api/v1/admin/dev/companies/${id}/features`);
          
          const saved = await req(`/api/v1/admin/dev/companies/${id}/features`, { 
            method:'PATCH', 
            body: payload
          });
          
          console.log('Save response:', saved);
          
          if (saved?.features) {
            company.features = saved.features;
            const idx = companiesData.findIndex(c => String(c._id || c.id || '') === id);
            if (idx >= 0) companiesData[idx].features = saved.features;
          }
          
          // Actualizar los toggles visualmente inmediatamente usando los datos guardados
          console.log('Updating toggles for company:', company);
          console.log('Saved features:', saved.features);
          console.log('Saved feature options:', saved.featureOptions);
          
          // Usar los datos que realmente se guardaron
          const updatedCompany = { ...company };
          if (saved.features) updatedCompany.features = saved.features;
          if (saved.featureOptions) updatedCompany.featureOptions = saved.featureOptions;
          
          updateTogglesFromData(div, updatedCompany);
          
          // Mostrar mensaje de éxito
          alert('Modulos guardados');
          
          // Aplicar cambios a la UI principal
          window.applyDevChanges();
        } catch (e) { 
          console.error('Error saving features:', e);
          alert(e.message || 'Error'); 
        }
      };
    } else {
      console.error('Save features button not found!');
    }

    const saveFoptsBtn = div.querySelector('[data-save-fopts]');
    console.log('Save feature options button found:', saveFoptsBtn);
    
    if (saveFoptsBtn) {
      saveFoptsBtn.onclick = async () => {
        try {
          const payload = readFeatureOptionsPayload();
          console.log('Saving feature options for company:', id, 'payload:', payload);
          console.log('API_BASE:', window.API_BASE);
          console.log('Full URL:', (window.API_BASE||'') + `/api/v1/admin/dev/companies/${id}/feature-options`);
          
          const saved = await req(`/api/v1/admin/dev/companies/${id}/feature-options`, { 
            method:'PATCH', 
            body: payload
          });
          
          console.log('Save response:', saved);
          
          if (saved?.featureOptions) {
            company.featureOptions = saved.featureOptions;
            const idx = companiesData.findIndex(c => String(c._id || c.id || '') === id);
            if (idx >= 0) companiesData[idx].featureOptions = saved.featureOptions;
          }
          
          // Actualizar los toggles visualmente inmediatamente usando los datos guardados
          console.log('Updating toggles for company:', company);
          console.log('Saved features:', saved.features);
          console.log('Saved feature options:', saved.featureOptions);
          
          // Usar los datos que realmente se guardaron
          const updatedCompany = { ...company };
          if (saved.features) updatedCompany.features = saved.features;
          if (saved.featureOptions) updatedCompany.featureOptions = saved.featureOptions;
          
          updateTogglesFromData(div, updatedCompany);
          
          // Mostrar mensaje de éxito
          alert('Opciones guardadas');
          
          // Aplicar cambios a la UI principal
          window.applyDevChanges();
        } catch (e) { 
          console.error('Error saving feature options:', e);
          alert(e.message || 'Error'); 
        }
      };
    } else {
      console.error('Save feature options button not found!');
    }

    div.querySelector('[data-save-restr]').onclick = async () => {
      // Restricciones removidas - no hay nada que guardar
      alert('No hay restricciones configuradas');
    };
    return div;
  }

  function renderCompaniesList(){
    const wrap = document.getElementById('c-list');
    console.log('Looking for #c-list element:', wrap);
    if(!wrap) {
      console.error('Element #c-list not found!');
      return;
    }
    console.log('renderCompaniesList called with companiesData:', companiesData);
    
    if(!companiesData.length){
      wrap.innerHTML = '<div class="dev-empty">No hay empresas registradas</div>';
      const statsEl = document.getElementById('c-stats');
      if(statsEl) statsEl.textContent = '0 empresas';
      return;
    }
    const term = (document.getElementById('c-filter')?.value || '').trim().toLowerCase();
    const filtered = term
      ? companiesData.filter(c=>{
          const vals = [c.name, c.email, c.documentNumber, c.city].filter(Boolean).map(v=>String(v).toLowerCase());
          return vals.some(v=> v.includes(term));
        })
      : [...companiesData];
    const statsEl = document.getElementById('c-stats');
    wrap.innerHTML = '';
    if(!filtered.length){
      wrap.innerHTML = '<div class="dev-empty">No se encontraron empresas</div>';
    }else{
      console.log('Rendering', filtered.length, 'companies');
      filtered.forEach(c=> {
        console.log('Building card for company:', c);
        const card = buildCompanyCard(c);
        wrap.appendChild(card);
      });
    }
    if(statsEl){
      const activeFiltered = filtered.filter(c=> c.active).length;
      statsEl.innerHTML = `${filtered.length} de ${companiesData.length} empresas <span class="bullet"></span> ${activeFiltered} activas`;
    }
  }

  async function loadCompanies(force=false){
    const wrap = document.getElementById('c-list');
    if(!wrap) return;
    console.log('loadCompanies called, force:', force, 'companiesData.length:', companiesData.length);
    
    if(force || !companiesData.length){
      wrap.innerHTML = '<div class="muted">Cargando empresas reales...</div>';
      
      // Cargar empresas reales usando el token de desarrollador
      try {
        console.log('Loading companies from API...');
        const res = await req('/api/v1/admin/company/companies');
        companiesData = res.items || [];
        console.log('Real companies loaded from API:', companiesData);
        
        setHeroStat('stat-companies', companiesData.length);
        setHeroStat('stat-companies-active', companiesData.filter(c=>c.active).length);
      } catch(e) {
        console.log('Error loading real companies:', e);
        // Fallback: crear empresa demo si falla
        companiesData = [{
          _id: 'dev-company',
          name: 'Empresa Demo',
          email: 'demo@empresa.com',
          active: true,
          features: {},
          featureOptions: {}
        }];
        setHeroStat('stat-companies', 1);
        setHeroStat('stat-companies-active', 1);
      }
    }
    console.log('Rendering companies list with:', companiesData);
    renderCompaniesList();
  }

  document.getElementById('c-refresh').onclick = () => loadCompanies(true);
  document.getElementById('c-filter')?.addEventListener('input', () => renderCompaniesList());
  document.getElementById('c-clear')?.addEventListener('click', ()=>{
    const input = document.getElementById('c-filter');
    if(!input) return;
    input.value = '';
    renderCompaniesList();
    input.focus();
  });

  // Tabs behavior
  const devTabs = document.getElementById('devTabs');
  const requestsCard = document.getElementById('requestsCard');
  const requestsContent = document.getElementById('requestsContent');
  const companiesCard = document.getElementById('companiesCard');
  const adminsCard = document.getElementById('adminsCard');
  function focusCompanyCard(id, message){
    const safeId = (window.CSS && CSS.escape) ? CSS.escape(id) : String(id).replace(/[^a-zA-Z0-9_-]/g,'');
    const card = document.querySelector(`.dev-company-card[data-company-id="${safeId}"]`);
    if(card){
      card.scrollIntoView({ behavior:'smooth', block:'start' });
      card.classList.add('dev-card-flash');
      setTimeout(()=> card.classList.remove('dev-card-flash'), 900);
    }
    if(message) alert(message);
  }
  async function reloadCompaniesAndFocus(id, message){
    // En lugar de recargar todo, solo actualizar los datos y los toggles
    try {
      const res = await req('/api/v1/admin/company/companies');
      companiesData = res.items || [];
      
      // Actualizar solo la tarjeta específica
      const card = document.querySelector(`.dev-company-card[data-company-id="${id}"]`);
      if (card) {
        const company = companiesData.find(c => String(c._id || c.id || '') === id);
        if (company) {
          updateTogglesFromData(card, company);
        }
      }
      
      requestAnimationFrame(()=> focusCompanyCard(id, message));
    } catch (e) {
      console.error('Error reloading company data:', e);
      // Fallback: recargar todo
      await loadCompanies(true);
      requestAnimationFrame(()=> focusCompanyCard(id, message));
    }
  }
  const toggleSections = (t)=>{
    if(requestsContent) requestsContent.style.display = (t==='reqs') ? '' : 'none';
    if(companiesCard) companiesCard.style.display = (t==='companies') ? '' : 'none';
    if(adminsCard) adminsCard.style.display = (t==='admins') ? '' : 'none';
    if(requestsCard) requestsCard.classList.toggle('active', t==='reqs');
  };
  devTabs?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-t]'); if(!btn) return;
    devTabs.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.t;
    toggleSections(t);
    if(t==='companies') loadCompanies();
    if(t==='admins') loadAdmins();
    if(t==='reqs') loadReqs();
  });
  const activeTab = devTabs?.querySelector('button.active')?.dataset.t;
  if(activeTab) toggleSections(activeTab);
  
  // Mostrar la sección de empresas por defecto en el panel de desarrollo
  if(companiesCard) {
    companiesCard.style.display = '';
    console.log('Companies section made visible');
  }
  
  // Botón de aplicar cambios
  document.getElementById('dev-apply').onclick = () => {
    // Aplicar cambios inmediatamente
    if (typeof window.applyDevChanges === 'function') {
      window.applyDevChanges();
    }
    
    // Mostrar mensaje de confirmación
    const btn = document.getElementById('dev-apply');
    const originalText = btn.textContent;
    btn.textContent = '✓ Aplicado';
    btn.style.background = 'rgba(34,197,94,0.2)';
    btn.style.color = '#16a34a';
    
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = 'rgba(34,197,94,0.1)';
      btn.style.color = '#22c55e';
    }, 2000);
  };
  
  // Botón de cerrar sesión
  document.getElementById('dev-logout').onclick = () => {
    setTok('');
    document.getElementById('loginSection').classList.remove('hidden');
    document.getElementById('appSection').classList.add('hidden');
    document.getElementById('d-pin').value = '';
  };
  
  // Enter en el campo PIN
  document.getElementById('d-pin').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('d-login').click();
    }
  });
  
  // Función global para aplicar cambios a la UI principal
  window.applyDevChanges = function() {
    console.log('Aplicando cambios a la UI principal...');
    
    // Limpiar cache de features en localStorage con patrones más específicos
    try {
      const keys = Object.keys(localStorage);
      keys.forEach(key => {
        // Limpiar todas las claves relacionadas con features
        if (key.includes('taller.features') || 
            key.includes('taller.featureOptions') || 
            key.includes('features') || 
            key.includes('featureOptions')) {
          localStorage.removeItem(key);
          console.log('Cleared cache key:', key);
        }
      });
      
      // También limpiar claves específicas que sabemos que existen
      const email = getTok()?.email || 'default';
      const featuresKey = `taller.features:${email}`;
      const optionsKey = `taller.featureOptions:${email}`;
      localStorage.removeItem(featuresKey);
      localStorage.removeItem(optionsKey);
      console.log('Cleared specific cache keys:', featuresKey, optionsKey);
    } catch (e) {
      console.warn('Error clearing cache:', e);
    }
    
    // Aplicar feature gating si está disponible
    if (typeof window.applyFeatureGating === 'function') {
      console.log('Aplicando feature gating...');
      window.applyFeatureGating();
    }
    
    // Recargar feature options si está disponible
    if (typeof window.reloadFeatureOptions === 'function') {
      console.log('Recargando feature options...');
      window.reloadFeatureOptions();
    }
    
    // Forzar recarga de la página principal si está abierta
    if (window.opener && !window.opener.closed) {
      console.log('Recargando ventana principal...');
      window.opener.location.reload();
    }
    
    // También intentar aplicar cambios en la misma ventana si estamos en la app principal
    if (window.location.href.includes('index.html') || window.location.href.includes('proyecto-taller')) {
      console.log('Recargando página actual...');
      window.location.reload();
    }
    
    // Notificar a la aplicación principal
    notifyMainApp();
    
    console.log('Cambios aplicados a la UI principal');
  };
  
  // Función para probar los toggles
  function testToggles() {
    console.log('Probando toggles...');
    const toggles = document.querySelectorAll('.dev-company-card .toggle input[type="checkbox"]');
    console.log('Toggles encontrados:', toggles.length);
    
    toggles.forEach((toggle, index) => {
      console.log(`Toggle ${index}:`, {
        id: toggle.id,
        checked: toggle.checked,
        parent: toggle.closest('.toggle')?.querySelector('.toggle-text')?.textContent
      });
    });
  }
  
  // Función para notificar a la aplicación principal sobre cambios
  function notifyMainApp() {
    console.log('Notificando a la aplicación principal...');
    
    // Enviar mensaje a la ventana principal si está abierta
    if (window.opener && !window.opener.closed) {
      try {
        const message = {
          type: 'DEV_PANEL_CHANGES',
          action: 'reload_features',
          timestamp: Date.now(),
          source: 'dev_panel'
        };
        window.opener.postMessage(message, '*');
        console.log('Notificación enviada a la ventana principal:', message);
      } catch (e) {
        console.warn('Error enviando notificación:', e);
      }
    }
    
    // También notificar a través de localStorage
    try {
      const timestamp = Date.now().toString();
      localStorage.setItem('dev_panel_changes', timestamp);
      localStorage.setItem('dev_panel_last_update', timestamp);
      console.log('Notificación guardada en localStorage:', timestamp);
    } catch (e) {
      console.warn('Error guardando notificación:', e);
    }
    
    // También intentar notificar a través de un evento personalizado
    try {
      window.dispatchEvent(new CustomEvent('devPanelChanges', {
        detail: { timestamp: Date.now(), source: 'dev_panel' }
      }));
      console.log('Evento personalizado disparado');
    } catch (e) {
      console.warn('Error disparando evento personalizado:', e);
    }
  }
  
  // Función de debug para verificar el estado de los toggles
  function debugToggles() {
    console.log('=== DEBUG TOGGLES ===');
    const allToggles = document.querySelectorAll('.dev-company-card .toggle input[type="checkbox"]');
    console.log('Total toggles found:', allToggles.length);
    
    allToggles.forEach((toggle, index) => {
      const parent = toggle.closest('.toggle');
      const label = parent?.querySelector('.toggle-text')?.textContent || 'Unknown';
      const slider = toggle.nextElementSibling;
      const sliderStyle = slider ? window.getComputedStyle(slider) : null;
      
      console.log(`Toggle ${index}:`, {
        id: toggle.id,
        label: label,
        checked: toggle.checked,
        sliderBackground: sliderStyle?.background,
        sliderTransform: sliderStyle?.transform
      });
    });
    console.log('=== END DEBUG ===');
  }
  
  // Función para verificar el estado de una empresa específica en el servidor
  async function debugCompanyState(companyId) {
    console.log('=== DEBUG COMPANY STATE ===');
    console.log('Checking company state for:', companyId);
    
    try {
      // Obtener features
      const features = await req(`/api/v1/admin/dev/companies/${companyId}/features`);
      console.log('Server features:', features);
      
      // Obtener feature options
      const featureOptions = await req(`/api/v1/admin/dev/companies/${companyId}/feature-options`);
      console.log('Server feature options:', featureOptions);
      
      // Obtener datos completos de la empresa
      const company = await req(`/api/v1/admin/dev/companies/${companyId}`);
      console.log('Server company data:', company);
      
      return { features, featureOptions, company };
    } catch (e) {
      console.error('Error checking company state:', e);
      return null;
    }
  }
  
  // Función para comparar estado local vs servidor
  async function compareLocalVsServer(companyId) {
    console.log('=== COMPARING LOCAL VS SERVER ===');
    
    const localCompany = companiesData.find(c => String(c._id || c.id || '') === companyId);
    console.log('Local company data:', localCompany);
    
    const serverData = await debugCompanyState(companyId);
    if (serverData) {
      console.log('Server data:', serverData);
      
      // Comparar features
      const localFeatures = localCompany?.features || {};
      const serverFeatures = serverData.features?.features || {};
      console.log('Features comparison:', {
        local: localFeatures,
        server: serverFeatures,
        match: JSON.stringify(localFeatures) === JSON.stringify(serverFeatures)
      });
      
      // Comparar feature options
      const localOptions = localCompany?.featureOptions || {};
      const serverOptions = serverData.featureOptions?.featureOptions || {};
      console.log('Feature options comparison:', {
        local: localOptions,
        server: serverOptions,
        match: JSON.stringify(localOptions) === JSON.stringify(serverOptions)
      });
    }
  }
  
  // Hacer las funciones disponibles globalmente para debugging
  window.debugToggles = debugToggles;
  window.debugCompanyState = debugCompanyState;
  window.compareLocalVsServer = compareLocalVsServer;
  
  // Ejecutar prueba de toggles después de cargar las empresas
  setTimeout(() => {
    testToggles();
    debugToggles();
  }, 2000);
  
  // Función global para debug
  window.debugToggles = debugToggles;
  </script>
</body>
</html>
























