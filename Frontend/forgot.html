<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Taller App - Recuperar contrase√±a</title>
<link rel="stylesheet" href="assets/styles.css" />
<!-- Carga la configuraci√≥n global (API_BASE, etc.) igual que index.html -->
<script src="./assets/js/config.js"></script>
<script src="./assets/js/api.js"></script>
<script type="module">
import { API } from './assets/js/api.esm.js';
const form = document.getElementById('forgot-form');
const emailInput = document.getElementById('forgot-email');
const nameInput = document.getElementById('company-name');
const passInput = document.getElementById('new-password');
const msg = document.getElementById('forgot-msg');
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  msg.classList.remove('error');
  msg.textContent='Procesando‚Ä¶';
  try {
    const email = emailInput.value.trim();
    const companyName = nameInput.value.trim();
    const newPassword = passInput.value.trim();
    if(newPassword.length < 6) throw new Error('La nueva contrase√±a debe tener al menos 6 caracteres');
    const apiBase = (API.base || window.API_BASE || window.BACKEND_URL || '');
    const res = await fetch(apiBase + '/api/v1/auth/company/password/reset-local', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, companyName, newPassword })
    });
    const text = await res.text();
    let data={};
    try { data = text ? JSON.parse(text) : {}; } catch { throw new Error('Respuesta inv√°lida del servidor'); }
    if(!res.ok) throw new Error(data.error || 'Error en solicitud');
    msg.textContent = 'Contrase√±a actualizada. Ahora puedes volver e iniciar sesi√≥n.';
    passInput.value='';
  } catch(err){
    msg.classList.add('error');
    msg.textContent = err.message || 'Error inesperado';
  }
});
</script>
<style>
body{max-width:520px;margin:40px auto;padding:0 16px;}
.card{margin-top:30px;}
h1{text-align:center;}
form button{width:100%; margin-top:14px;}
#forgot-msg.error{color:#ef4444;}
.muted a{color:var(--accent);}
.back-link{display:inline-block;margin-top:24px;font-size:13px;}
</style>
</head>
<body>
  <nav class="tabs">
    <button data-tab="home" data-href="index.html">Inicio</button>
    <button data-tab="notas" data-href="notas.html">Notas</button>
    <button data-tab="ventas" data-href="ventas.html">Ventas</button>
    <button data-tab="cotizaciones" data-href="cotizaciones.html">Cotizaciones</button>
    <button data-tab="inventario" data-href="inventario.html">Inventario</button>
    <button data-tab="precios" data-href="precios.html">Lista de precios</button>
    <button data-tab="cashflow" data-href="cashflow.html">Flujo de Caja</button>
    <button data-tab="reporte-tecnico" data-href="reporte-tecnico.html">Reporte T√©cnico</button>
    <button data-tab="formatos" data-href="template-selector.html">Formatos</button>
    <button data-tab="skus" data-href="skus.html">SKUs</button>
    <button data-tab="forgot" data-href="forgot.html" class="active">Recuperar contrase√±a</button>
    <button id="themeToggle" class="secondary" title="Cambiar tema">üåó</button>
  </nav>
  <h1>Recuperar contrase√±a</h1>
  <div class="card">
    <form id="forgot-form">
      <label>Correo de la cuenta</label>
      <input id="forgot-email" type="email" required />
      <label>Nombre exacto de la empresa</label>
      <input id="company-name" type="text" placeholder="Como fue registrado" required />
      <label>Nueva contrase√±a</label>
      <input id="new-password" type="password" required minlength="6" />
      <button>Cambiar contrase√±a</button>
    </form>
    <p id="forgot-msg" class="muted" style="margin-top:12px;"></p>
  <!-- Flujo local: ya no se usa token ni enlace -->
    <p class="back-link"><a href="index.html">‚Üê Volver</a></p>
  </div>
</body>
</html>
