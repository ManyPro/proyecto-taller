<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M&M - Cotizaciones</title>
  <link rel="stylesheet" href="assets/styles.css?v=20251010" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <script src="./assets/js/config.js"></script>
  <script>
    window.QUOTES_KEYS = { lastNumber: 'quotes:lastNumber', draft: 'quotes:current' };
  </script>
</head>
<body data-page="cotizaciones">
  <div class="topbar hidden" id="appHeader">
    <div class="topbar-inner">
      <div class="topbar-card">
        <div class="row between" style="align-items:center;gap:8px;flex-wrap:wrap;">
          <div class="brand">
            <img id="brandLogo" src="assets/lightlogo.png" alt="M&M logo" />
            <div class="company">Empresa: <span id="companyName">-</span></div>
          </div>
          <div class="row" style="gap:6px;align-items:center;">
            <button id="logoutBtn" class="secondary hidden">Salir</button>
            <button id="denseToggle" class="secondary" title="Modo compacto">📏</button>
            <button id="themeToggle" class="secondary" title="Cambiar tema">🌗</button>
          </div>
        </div>
        <div class="top-tabs">
          <nav class="tabs">
            <button data-tab="home" data-href="index.html">Inicio</button>
            <button data-tab="notas" data-feature="notas" data-href="notas.html">Notas</button>
            <button data-tab="ventas" data-feature="ventas" data-href="ventas.html">Ventas</button>
            <button data-tab="cotizaciones" data-feature="cotizaciones" data-href="cotizaciones.html" class="active">Cotizaciones</button>
            <button data-tab="inventario" data-feature="inventario" data-href="inventario.html">Inventario</button>
            <button data-tab="precios" data-feature="precios" data-href="precios.html">Lista de precios</button>
            <button data-tab="cashflow" data-feature="cashflow" data-href="cashflow.html">Flujo de Caja</button>
            <button data-tab="nomina" data-feature="payroll" data-href="nomina.html">Nómina</button>
            <button data-tab="formatos" data-feature="templates" data-href="template-selector.html">Formatos</button>
            <button data-tab="skus" data-feature="skus" data-href="skus.html">SKUs</button>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <main>
    <section id="appSection" class="hidden">

      <!-- MODAL GLOBAL -->
      <div id="modal" class="modal hidden">
        <div class="modal-content image-modal">
          <button id="modalClose" class="close">&times;</button>
          <div id="modalBody">
            <div id="modal-img-wrap">
              <img id="modal-img" src="" alt="Vista previa" />
              <div class="zoom-controls">
                <button id="zoom-in">+</button>
                <button id="zoom-out">-</button>
                <button id="zoom-reset">Reset</button>
              </div>
            </div>
          </div>
        </div>
      </div>

  <!-- ========== Cotizaciones ========== -->
  <section id="tab-cotizaciones" class="tab active">
        <!-- Arriba: 2 columnas -->
        <div class="grid-2" id="quotes-body">
          <!-- Izquierda: Datos -->
          <div class="card" id="q-data">
            <h3>Nueva Cotización</h3>

            <div class="row">
              <div class="field">
                <label>N.º cotización</label>
                <input id="q-number" disabled placeholder="00001" />
              </div>
              <div class="field">
                <label>Fecha y hora</label>
                <input id="q-datetime" disabled />
              </div>
            </div>

            <label>Cliente</label>
            <input id="q-client-name" placeholder="Nombre del cliente" />
            <div class="row">
              <input id="q-client-phone" placeholder="Teléfono (opcional)" />
              <input id="q-client-email" placeholder="Correo (opcional)" />
            </div>
            <input id="q-client-id" placeholder="Identificación (opcional)" />

            <label>Placa</label>
            <input id="q-plate" placeholder="ABC123" />
            <div style="position:relative;margin-top:8px;">
              <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:500;">Vehículo (opcional)</label>
              <input id="q-vehicle-search" placeholder="Buscar vehículo (marca, línea, cilindraje)..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);" />
              <div id="q-vehicle-dropdown" style="display:none;position:absolute;z-index:1000;background:var(--card);border:1px solid var(--border);border-radius:6px;max-height:200px;overflow-y:auto;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.15);width:100%;"></div>
              <input type="hidden" id="q-vehicle-id" />
              <div id="q-vehicle-selected" style="margin-top:4px;font-size:12px;color:var(--muted);"></div>
            </div>
            <div class="row">
              <input id="q-brand" placeholder="Marca" readonly style="background:var(--bg-secondary);" />
              <input id="q-line" placeholder="Línea/Modelo" readonly style="background:var(--bg-secondary);" />
            </div>
            <div class="row">
              <input id="q-year" placeholder="Año" />
              <input id="q-cc" placeholder="Cilindraje" readonly style="background:var(--bg-secondary);" />
            </div>
            <div id="q-year-warning" style="display:none;font-size:11px;color:var(--danger,#ef4444);margin-top:4px;"></div>
            <div class="row">
              <input id="q-mileage" placeholder="Kilometraje" type="number" min="0" step="1" />
            </div>

            <button id="q-saveDraft" class="secondary">Guardar borrador (local)</button>
          </div>

          <!-- Derecha: Resumen / Acciones -->
          <div class="card" id="q-summary">
            <h3>Resumen / Acciones</h3>
            <p class="q-no"><span>No. cotización: </span><strong id="q-number-big">00001</strong></p>
            <label>Validez (días, opcional)</label>
            <input id="q-valid-days" type="number" min="0" step="1" placeholder="p. ej. 8" />
            <label>Vista previa WhatsApp</label>
            <pre id="q-whatsappPreview" style="min-height:220px;white-space:pre-wrap;"></pre>
            
            <!-- Sección de notas especiales -->
            <div id="q-special-notes-section" style="margin-top: 16px;">
              <label>Notas especiales</label>
              <div id="q-special-notes-list"></div>
              <button id="q-add-special-note" class="secondary" style="margin-top: 8px;">+ Agregar nota especial</button>
            </div>
            
            <div class="row">
              <button id="q-clearAll" class="secondary">Borrar todo</button>
            </div>
          </div>

          <!-- Abajo: ítems (a todo el ancho) -->
          <div class="card span-2" id="q-items-card">
            <h3>Ítems</h3>

            <!-- Contenedor de ítems en 2 columnas -->
            <div id="q-rows" class="q-grid-2cols">
              <!-- Plantilla oculta de ítem -->
              <div class="tr q-row-card hidden" id="q-row-template" data-template>
                <div>
                  <label class="sr-only">Tipo</label>
                  <select>
                    <option value="PRODUCTO">Producto</option>
                    <option value="SERVICIO">Servicio</option>
                  </select>
                </div>
                <div>
                  <label class="sr-only">Descripción</label>
                  <input placeholder="Descripción" />
                </div>
                <div class="small">
                  <label class="sr-only">Cant.</label>
                  <input type="number" min="0" step="1" placeholder="Cant." />
                </div>
                <div class="small">
                  <label class="sr-only">Precio</label>
                  <input type="number" min="0" step="0.01" placeholder="Precio" />
                </div>
                <div class="small">
                  <label class="sr-only">Precio mínimo</label>
                  <input type="number" min="0" step="0.01" placeholder="Precio mín." class="min-price-input" style="display: none; width: 100%;" />
                  <button type="button" class="secondary min-price-btn" style="font-size: 11px; padding: 6px 10px; width: 100%; border-radius: 4px; background: #6c757d; color: white; border: none; cursor: pointer; transition: background 0.2s ease;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Precio mín.</button>
                </div>
                <div class="small">
                  <label class="sr-only">Subtotal</label>
                  <input disabled placeholder="$0" />
                </div>
                <div class="small">
                  <button class="secondary" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: background 0.2s ease; width: 100%;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">Quitar</button>
                </div>
              </div>
            </div>

            <div class="row" id="q-addbar">
              <button id="q-addRow">+ Agregar línea</button>
              <button id="q-addQR" class="secondary">Agregar por QR</button>
            </div>

            <div class="totals">
              <div>Subtotal Productos: <strong id="q-subtotal-products">$0</strong></div>
              <div>Subtotal Servicios: <strong id="q-subtotal-services">$0</strong></div>
              <div id="q-discount-section" style="display: none;">
                <div>Descuento: <strong id="q-discount-amount">$0</strong></div>
              </div>
              <div>Total: <strong id="q-total">$0</strong></div>
            </div>
            
            <!-- Botones de descuento -->
            <div class="row" style="margin-top: 12px; gap: 8px;">
              <button id="q-discount-percent" class="secondary" style="background: #10b981; color: white; border: none;">Descuento %</button>
              <button id="q-discount-fixed" class="secondary" style="background: #3b82f6; color: white; border: none;">Descuento $</button>
              <button id="q-discount-clear" class="secondary" style="background: #ef4444; color: white; border: none; display: none;">Quitar descuento</button>
            </div>

            <div class="row">
              <button id="q-saveBackend">Guardar en historial</button>
              <button id="q-sendWhatsApp">Enviar por WhatsApp</button>
              <button id="q-exportPdf" class="secondary">Exportar PDF</button>
            </div>
          </div>

          <!-- Debajo de ítems: Historial (a todo el ancho) -->
          <div class="card span-2" id="q-history-card">
            <h3>Historial de Cotizaciones</h3>
            <div class="row wrap" id="q-history-filters">
              <input id="qh-text" placeholder="Buscar por cliente o placa..." />
              <input id="qh-from" type="date" />
              <input id="qh-to" type="date" />
              <button id="qh-apply" class="secondary">Buscar</button>
              <button id="qh-clear" class="secondary">Limpiar</button>
            </div>
            <div id="q-history-list" class="q-history-list"></div>
          </div>
        </div>
      </section>

    </section>
  </main>

  <script src="./assets/js/api.js"></script>
  <script type="module" src="./assets/js/quotes.js" charset="utf-8"></script>
  <script type="module" src="./assets/js/app.js" charset="utf-8"></script>
  <script src="./assets/js/input-fix.js"></script>
</body>
</html>


